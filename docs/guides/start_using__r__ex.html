<p>This is a small howto showing the first steps with Rex.</p>
<h1>Basic Architecture</h1>
<p><img style="float: right;" src="../../media/docs/archi.png" alt="" width="410" height="272" />Rex is a server orchestration tool that doesn't need an agent on the hosts you want to manage. In fact it uses ssh to execute the given commands.<br /><br />To use Rex you don't need Perl knowledge at first. Rex uses a simple DSL to describe your servers. Indeed, it is also possible to use Rex from within your shell scripts without using perl at all.<br /><br />In fact, if you know a little bit perl it won't hurt you.<br /><br />The starting point of every Rex project is the so called Rexfile. You can think of this file like a Makefile. You can define tasks in this file.<br /><br />A task is a bunch of related commands. For example installing a package, uploading the configuration file and starting the service. You can also call tasks from other tasks or create rollback scenarios if something went wrong during the execution.</p>
<h1>Requirements</h1>
<p>To run Rex you don't need much.</p>
<h2>Central Master Host</h2>
<p>You can run Rex from your workstation or on a central master host.<br /><br />For your central Rex machine (the master) you need at least Perl 5.8. For a better experience we recommend using Perl 5.10.1 and above.<br /><br />On this host you also need some Perl modules installed. If you're using the provided packages or install Rex via cpanm the dependencies will be installed automatically.</p>
<p>You can install Rex on a Linux host via a simple one-liner. For other systems please read the instructions on the Get Rex page.</p>
<pre>$ curl -L https://get.rexify.org | perl - --sudo -n Rex</pre>
<p>This command will install Rex on your system. <br /><br />We recommend to use our packages from the repository.</p>
<h2>Managed Hosts</h2>
<p>On the systems you want to manage you need only two things: a Perl 5 interpreter, and a valid SSH account.</p>
<p>Rex only uses core Perl modules on the remote hosts, but some operating systems (e.g. RHEL/CentOS 7, Fedora 21) might not supply all of them out of the box. In this case you might need to install them first (currently this means the Digest::MD5 module).</p>
<p>You can install this module with <code>yum install perl-Digest-MD5</code>.</p>
<p>If you want to run administrative tasks on the remote machines, you obviously would need root or sudo access on them.<br /><br /></p>
<h1>Creating a Rexfile</h1>
<p>First we need to create a new folder to store your Rexfile in it.</p>
<pre>$ mkdir -p projects/my-first-rex-project</pre>
<p>Now change into this directory and create a file called Rexfile with the following contents:</p>
<pre class="perl"><code class="perl">use Rex -feature =&gt; ['1.3'];<br /><br /></code><code class="perl">user "my-user";<br /></code><code class="perl">password "my-password";<br /><br /></code><code class="perl">group myservers =&gt; "mywebserver", "mymailserver", "myfileserver";<br /><br /></code><code class="perl">desc "Get the uptime of all servers";<br /></code><code class="perl">task "uptime", group =&gt; "myservers", sub {<br /></code><code class="perl">&nbsp;&nbsp; my $output = run "uptime";<br /></code><code class="perl">&nbsp;&nbsp; say $output;<br /></code><code class="perl">};</code></pre>
<p>This Example will login as my-user with the password my-password on all the servers in the group myservers and run the command "uptime".<br /><br />The special first line <code>use Rex -feature =&gt; ['1.3'];</code> enables all features that are available for version 1.3. If you want to know more about feature flags, please read this page.<br /><br />Change into the directory where you just created the Rexfile (in a terminal).</p>
<pre>$ cd projects/my-first-rex-project<br />$ rex uptime</pre>
<h2>Adding a second task</h2>
<p>To add a second task, just add the next lines to your Rexfile.</p>
<pre><code class="perl">desc "Start Apache Service";<br /></code><code class="perl">task "start_apache", group =&gt; "myservers", sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; service "apache2" =&gt; "start";<br /></code><code class="perl">};</code></pre>
<p>This task will start the service apache2 on all the servers in the myservers group.<br />Display all tasks in a Rexfile<br /><br />If you want to display all tasks in your Rexfile use the following command.</p>
<pre>$ rex -T<br />Tasks<br />&nbsp; start_apache&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Start Apache Service<br />&nbsp; uptime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get the uptime of all servers<br />Server Groups<br />&nbsp; myservers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mywebserver, mymailserver, myfileserver</pre>
<h2>Authentication</h2>
<p>In the previous example we showed you how you can login with a user and a password. But it is also possible to use key authentication.<br /><br />To use key authentication just define your private and public key inside the Rexfile.</p>
<pre><code class="perl">user "my-user";<br /></code><code class="perl">private_key "/home/user/.ssh/id_rsa";<br /></code><code class="perl">public_key "/home/user/.ssh/id_rsa.pub";<br /></code><code class="perl">key_auth;</code></pre>
<p>It is also possible to use your keys with a passphrase. Just add it to your Rexfile.</p>
<pre><code class="perl">user "my-user";<br /></code><code class="perl">private_key "/home/user/.ssh/id_rsa";<br /></code><code class="perl">public_key "/home/user/.ssh/id_rsa.pub";<br /></code><code class="perl">password "key-passphrase";<br /></code><code class="perl">key_auth;</code></pre>
<p>If you don't want to add your passphrase to the Rexfile you can also use ssh-agent. Rex will automatically use it when it is running. Just remove the line key_auth;.</p>
<h2>Managing Services</h2>
<p>If you want to manage services you often need to upload a configuration file and to register the service to start at boot time.<br /><br />In this example you will learn how to install and configure ntp. You can adapt this example to every other service easily.</p>
<pre><code class="perl"># Rexfile<br /></code><code class="perl">use Rex -feature =&gt; ['1.3'];<br /><br /></code><code class="perl">user "root";<br /></code><code class="perl">private_key "/root/.ssh/id_rsa";<br /></code><code class="perl">public_key "/root/.ssh/id_rsa.pub";<br /><br /></code><code class="perl">group all_servers =&gt; "srv[001..150]";<br /><br /></code><code class="perl">task "setup_ntp", group =&gt; "all_servers", sub {<br /></code><code class="perl">&nbsp;&nbsp; # first we will install the package<br /></code><code class="perl">&nbsp;&nbsp; pkg "ntpd",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "present";</code><br /><code class="perl"><br />&nbsp;&nbsp; # then we will upload a configuration file.<br /></code><code class="perl">&nbsp;&nbsp; # the configuration file is located in a subdirectory files/etc.<br /></code><code class="perl">&nbsp;&nbsp; file "/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp; =&gt; "files/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on_change =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # we define a on_change hook, so that the ntpd server gets restarted if the file is modified.<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service ntpd =&gt; "restart";<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</code><br /><code class="perl"><br />&nbsp;&nbsp; # now we register the service to start at boot time.<br /></code><code class="perl">&nbsp;&nbsp; service "ntpd",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "started";<br /></code><code class="perl">};</code></pre>
<p>That's all.<br /><br />This task will now install ntpd on your servers, upload a configuration file and start the service.<br /><br />You don't need to worry about the order of your commands. Rex will always executes your commands from top to bottom.<br /><br />To read more about <a href="../../docs/guides/using_modules_and_templates.html">using modules and templates please read this howto</a>.</p>