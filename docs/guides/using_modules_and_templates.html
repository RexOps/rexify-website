<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Using Modules and Templates</title>

      <meta content="Using Modules and Templates" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://rexify.org/docs/guides/using_modules_and_templates.html" property="og:url">
      <meta content="https://rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2021-03-05</b><br>
                     <a href="/blog/2021/03/05/rex-1.13.3.html">Rex-1.13.3</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.3.html">Rex-1.13.3 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.3">available on CPAN</a>. It contains documentation updates, and a fix for debconf parsing. Behind the scenes, CI was migrated over to GitHub Actions as well.</p>

                   <p><b>2020-12-05</b><br>
                     <a href="/blog/2020/12/05/rex-1.13.2.html">Rex-1.13.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.2.html">Rex-1.13.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.2">available on CPAN</a>. It contains only documentation updates, mostly for the built-in template capabilities, but also fixes a few typos.</p>

                   <p><b>2020-11-05</b><br>
                     <a href="/blog/2020/11/05/rex-1.13.1.html">Rex-1.13.1</a></p><p>
                   </p><p></p><p><a href="https://github.com/RexOps/Rex/commit/cabbc6a8aa9eb2c0d9d3fc2439be51924edc3ff8">Happy 10th birthday, Rex!</a></p>

<p>The <a href="/docs/release_notes/1.13.1.html">Rex-1.13.1 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.1">available on CPAN</a>. It is focusing on CMDB bugfixes and documentation, while also fixing a missing feature flag. Upgrade is recommended for all users.</p>

                   <p><b>2020-10-05</b><br>
                     <a href="/blog/2020/10/05/rex-1.13.0.html">Rex-1.13.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.0.html">Rex-1.13.0 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.0">available on CPAN</a>. It adds <code>on_no_change</code> hooks for file management commands to trigger further actions when files are left unchanged. Upgrade is recommended for all users.</p>

                   <p><b>2020-09-05</b><br>
                     <a href="/blog/2020/09/05/rex-1.12.2.html">Rex-1.12.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.12.2.html">Rex-1.12.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.12.2">available on CPAN</a>. It fixes various regressions, as well as bugs around file management. Upgrade is highly recommended for all users.</p>


               <h2>Events</h2>
                   <p><b>2021-03-08</b><br>
                     <a href="/blog/2021/03/04/learn_automation_using_rex.html">Learning automation using Rex</a></p><p>
                   </p><p></p><p>Ferenc Erki (FErki) will be the guest of <a href="https://www.linkedin.com/in/szabgab/">Gábor Szabó</a> on the next Code Maven live stream to learn about automation using Rex. Register for the free event via <a href="https://code-maven.com/automation-with-rex">Code Maven</a> or <a href="https://www.meetup.com/Code-Mavens/events/276730377/">Meetup</a>, and join the discussion!</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/unexpected_use_cases_with_rex.html">Unexpected use cases with Rex</a></p><p>
                   </p><p></p><p><a href="https://act.yapc.eu/gpw2020/talk/7699">Unexpected use cases with Rex</a> at the <a href="https://act.yapc.eu/gpw2020/index.html">22nd German Perl/Raku Workshop 2020</a> in Erlangen by Ferenc Erki (FErki).</p>

                   <p><b>2019-11-09</b><br>
                     <a href="/blog/2019/11/09/rex_and_friends_2019.html">Rex &amp; Friends</a></p><p>
                   </p><p></p><p><a href="https://friends.barcelona.pm/2019/#/talks/rex-and-friends">Rex &amp; Friends</a> talk at the <a href="https://friends.barcelona.pm">Barcelona Perl &amp; Friends 2019</a> by Ferenc Erki (FErki).</p>


            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/guides/index.html">Guides</a>
» <a href="/docs/guides/using_modules_and_templates.html">Using Modules and Templates</a>
</p>

              
              <h1>Using Modules and Templates</h1>
              <p>Uploading hardcoded configuration files to your servers often isn&#39;t enough. Sometimes you must add values dynamically inside a file. For example if you want to bind a service to a special network interface or to configure different database servers for your application for your different environments. This can be easily achieved with templates.</p>

<p>In this example you will learn how to build a ntp module that uploads custom ntp.conf files for your test-, pre-prod-, and production environment.</p>

<p>First, we create a new module. For this guide you need at least Rex 0.41 (because of the --create-module command and the case keyword.) Execute the following command in the same directory where your Rexfile lives.</p>

<pre><code>rexify Service::NTP --create-module
</code></pre>

<p>This will create some new directories and files in your lib directory.</p>

<pre><code>.
├── Rexfile
└── lib
    └── Service
        └── NTP
            ├── __module__.pm
            └── meta.yml
</code></pre>

<p>The meta.yml file can be ignored. This file is only important if you want to share your module on the Rex modules directory.</p>

<p>The important file is __module__.pm. Open this file in an editor.
This file is a normal Perl module. The only special thing is the filename, but don&#39;t think too much for it at first.</p>

<pre><code class="hljs"><span class="hljs-keyword">package</span> <span class="hljs-function">Service::NTP</span>;
<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.3</span>&#39;];

task prepare =&gt; <span class="hljs-keyword">sub </span>{
    <span class="hljs-keyword">my</span> <span class="hljs-type">$service_name</span> = case operating_system, {
        Debian    =&gt; &quot;<span class="hljs-string">ntp</span>&quot;,
          default =&gt; &quot;<span class="hljs-string">ntpd</span>&quot;,
    };
    pkg &quot;<span class="hljs-string">ntp</span>&quot;, ensure =&gt; &quot;<span class="hljs-string">present</span>&quot;;

    file &quot;<span class="hljs-string">/etc/ntp.conf</span>&quot;,
      source    =&gt; &quot;<span class="hljs-string">files/etc/ntp.conf</span>&quot;,
      on_change =&gt; <span class="hljs-keyword">sub </span>{
        service <span class="hljs-type">$service_name</span> =&gt; &quot;<span class="hljs-string">restart</span>&quot;;
      };

    service <span class="hljs-type">$service_name</span>, ensure =&gt; &quot;<span class="hljs-string">started</span>&quot;;
};

<span class="hljs-number">1</span>;</code></pre>

<p>First the module checks if the OS is a Debian (or Ubuntu) and set the service name to &quot;ntp&quot; otherwise to &quot;ntpd&quot;. After that it installs the &quot;ntp&quot; package and uploads the configuration file. Notice the on_change hook here. This will restart the ntp service if the file changes. At last Rex verifies that the service will start on system boot.
Now it is time to create a basic ntp.conf file. Create the directory lib/Service/NTP/files/etc and place the ntp.conf file in there.</p>

<pre><code class="hljs"><span class="hljs-comment"># /etc/ntp.conf, managed by Rex</span><span class="hljs-comment">
</span>
driftfile /var/run/ntp.drift

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

server ntp01.company.tld
server ntp02.company.tld</code></pre>

<p>If you now want to distribute different ntp.conf files per environment you can add multiple ntp.conf files to that directory. Rex will than decide with the help of the -E $env cli parameter which file to use. Rex first try to find a file named ntp.conf.$environment and if that file does not exist it falls back to ntp.conf.</p>

<pre><code class="hljs">.
├── Rexfile
└── lib
    └── Service
        └── NTP
            ├── __module__.pm
            ├── files
            │   └── etc
            │       ├── ntp.conf
            │       ├── ntp.conf.preprod
            │       ├── ntp.conf.prod
            │       └── ntp.conf.test
            └── meta.yml</code></pre>

<p>But if you want to change a parameter in your ntp.conf file you have to edit 4 files. This is not really cool. To prevent that you can use templates.</p>

<pre><code class="hljs">package <span class="hljs-function">Service::NTP</span>;
<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

task prepare =&gt; <span class="hljs-keyword">sub </span>{
    <span class="hljs-keyword">my</span> <span class="hljs-type">$service_name</span> = case operating_system, {
        Debian    =&gt; &quot;<span class="hljs-string">ntp</span>&quot;,
          default =&gt; &quot;<span class="hljs-string">ntpd</span>&quot;,
    };

    <span class="hljs-keyword">my</span> <span class="hljs-type">$ntp_server</span> = case environment, {
        prod      =&gt; [ &quot;<span class="hljs-string">ntp01.company.tld</span>&quot;, &quot;<span class="hljs-string">ntp02.company.tld</span>&quot; ],
          preprod =&gt; [&quot;<span class="hljs-string">ntp01.preprod.company.tld</span>&quot;],
          test    =&gt; [&quot;<span class="hljs-string">ntp01.test.company.tld</span>&quot;],
          default =&gt; [&quot;<span class="hljs-string">ntp01.company.tld</span>&quot;],
    };

    pkg &quot;<span class="hljs-string">ntp</span>&quot;, ensure =&gt; &quot;<span class="hljs-string">present</span>&quot;;

    file &quot;<span class="hljs-string">/etc/ntp.conf</span>&quot;,
      content   =&gt; template( &quot;<span class="hljs-string">files/etc/ntp.conf</span>&quot;, ntp_servers =&gt; <span class="hljs-type">$ntp_server</span> ),
      on_change =&gt; <span class="hljs-keyword">sub </span>{
        service <span class="hljs-type">$service_name</span> =&gt; &quot;<span class="hljs-string">restart</span>&quot;;
      };

    service <span class="hljs-type">$service_name</span>, ensure =&gt; &quot;<span class="hljs-string">started</span>&quot;;
};

<span class="hljs-number">1</span>;</code></pre>

<p>Now we can create our template. The default template of Rex looks similar to other templating engines. But you can also use other template engines like Template::Toolkit.</p>

<pre><code># /etc/ntp.conf, managed by Rex

driftfile /var/run/ntp.drift

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

&lt;% for my $server (@{ $ntp_servers }) { %&gt;
server &lt;%= $server %&gt;
&lt;% } %&gt;
</code></pre>

<h2 id="predefinedvariables">Predefined Variables</h2>

<p>There are also some predefined variables you can use in your templates. For example the ip address of a network device if you want to bind a service on a specific ip. You can dump all predefined variable of a system with the following code.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">get_infos</span>&quot;, &quot;<span class="hljs-string">server01</span>&quot;, <span class="hljs-keyword">sub </span>{
    dump_system_information;
};</code></pre>

<p>For example this is the output of a CentOS VM</p>

<pre><code>$kernelversion = &#39;#1 SMP Tue May 15 22:09:39 BST 2012&#39;
$memory_cached = &#39;357&#39;
$memory_total = &#39;498&#39;
$kernelrelease = &#39;2.6.32-220.17.1.el6.i686&#39;
$Kernel = {
      kernelversion =&gt; &#39;#1 SMP Tue May 15 22:09:39 BST 2012&#39;
      architecture =&gt; &#39;i686&#39;
      kernel =&gt; &#39;Linux&#39;
      kernelrelease =&gt; &#39;2.6.32-220.17.1.el6.i686&#39;
   }
$hostname = &#39;c6test0232&#39;
$operatingsystem = &#39;CentOS&#39;
$operatingsystemrelease = &#39;6.2&#39;
$architecture = &#39;i686&#39;
$domain = &#39;test.rexify.org&#39;
$eth0_mac = &#39;00:1C:42:9E:0E:28&#39;
$kernel = &#39;Linux&#39;
$swap_free = &#39;2005&#39;
$VirtInfo = {
      virtualization_role =&gt; &#39;guest&#39;
      virtualization_type =&gt; &#39;parallels&#39;
   }
$memory_shared = &#39;0&#39;
$Network = {
      networkdevices =&gt; [
         &#39;eth0&#39;
      ]
      networkconfiguration =&gt; {
         eth0 =&gt; {
            broadcast =&gt; &#39;10.211.55.255&#39;
            ip =&gt; &#39;10.211.55.60&#39;
            netmask =&gt; &#39;255.255.255.0&#39;
            mac =&gt; &#39;00:1C:42:9E:0E:28&#39;
         }
      }
   }
$memory_used = &#39;440&#39;
$kernelname = &#39;Linux&#39;
$Swap = {
      free =&gt; &#39;2005&#39;
      used =&gt; &#39;10&#39;
      total =&gt; &#39;2015&#39;
   }
$swap_total = &#39;2015&#39;
$memory_buffers = &#39;47&#39;
$eth0_ip = &#39;10.211.55.60&#39;
$swap_used = &#39;10&#39;
$memory_free = &#39;57&#39;
$manufacturer = &#39;Parallels Software International Inc.&#39;
$Memory = {
      shared =&gt; &#39;0&#39;
      buffers =&gt; &#39;47&#39;
      free =&gt; &#39;57&#39;
      used =&gt; &#39;440&#39;
      total =&gt; &#39;498&#39;
      cached =&gt; &#39;357&#39;
   }
$eth0_broadcast = &#39;10.211.55.255&#39;
$eth0_netmask = &#39;255.255.255.0&#39;
$Host = {
      domain =&gt; &#39;test.rexify.org&#39;
      manufacturer =&gt; &#39;Parallels Software International Inc.&#39;
      kernelname =&gt; &#39;Linux&#39;
      hostname =&gt; &#39;c6test0232&#39;
      operatingsystemrelease =&gt; &#39;6.2&#39;
      operatingsystem =&gt; &#39;CentOS&#39;
   }
</code></pre>

<p>You can use such predefined variable right in your template. Lets assume you want to bind apache only on your eth1 ip.</p>

<pre><code>Listen &lt;%= $eth1_ip %&gt;:80
</code></pre>

<h2 id="usingthemodule">Using the Module</h2>

<p>To use your module you have to add it to your Rexfile. This can be simply achieved with one line.</p>

<pre><code class="hljs"><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.3</span>&#39;];
user &quot;<span class="hljs-string">root</span>&quot;;
password &quot;<span class="hljs-string">foo</span>&quot;;

<span class="hljs-keyword">require</span> <span class="hljs-function">Service::NTP</span>;

<span class="hljs-number">1</span>;</code></pre>

<p>Than you can list your Tasks and execute them.</p>

<pre><code>$ rex -T
[2013-03-30 02:35:32] INFO - eval your Rexfile.
Tasks
  Service:NTP:prepare

$ rex -H yourserver01 Service:NTP:prepare
</code></pre>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="http://preaction.me/statocles/">Statocles</a></p>
      <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="https://matrix.to/#rexops:matrix.org">Matrix</a> / <a href="https://webchat.oftc.net/?channels=rexops">IRC</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://groups.google.com/group/rex-users/">Google Groups</a> / <a href="https://stackshare.io/rex">StackShare</a> / <a href="http://www.freelists.org/list/rex-users">Mailing list</a> / <a href="http://serverfault.com/questions/tagged/rex">Server Fault</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

   </body>

</html>
