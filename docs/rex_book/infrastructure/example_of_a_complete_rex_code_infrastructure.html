<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Example of a complete Rex code infrastructure</title>

      <meta content="Example of a complete Rex code infrastructure" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://www.rexify.org/docs/rex_book/infrastructure/example_of_a_complete_rex_code_infrastructure.html" property="og:url">
      <meta content="https://www.rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2020-06-05</b><br>
                     <a href="/blog/2020/06/05/rex-1.11.0.html">Rex-1.11.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.11.0.html">Rex-1.11.0 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.11.0">available on CPAN</a>. It enhances the behaviour of sysctl and file management, fixes bugs about group management and OpenSSH connection options, and clarifies quite a bit of documentation.</p>

                   <p><b>2020-05-05</b><br>
                     <a href="/blog/2020/05/05/rex-1.10.0.html">Rex-1.10.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.10.0.html">Rex-1.10.0 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a> (<a href="https://metacpan.org/source/FERKI/Rex-1.10.0/ChangeLog">changelog</a>). Apart from documentation updates and bug fixes, it adds initial package glob support, and an <code>on_change</code> hook for the <code>mkdir</code> command.</p>

                   <p><b>2020-04-05</b><br>
                     <a href="/blog/2020/04/05/rex-1.9.0.html">Rex-1.9.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.9.0.html">Rex-1.9.0 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, and it adds a new feature flag to force writing UTF-8 encoded files, <a href="https://metacpan.org/pod/Rex::Config">documents configuration options</a>, and fixes bugs.</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/rex-1.8.2.html">Rex-1.8.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.8.2.html">Rex-1.8.2 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, fixing a bug related to task hooks.</p>

                   <p><b>2020-02-05</b><br>
                     <a href="/blog/2020/02/05/rex-1.8.1.html">Rex-1.8.1</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.8.1.html">Rex-1.8.1 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, improving release automation, packaging, and documentation.</p>


               <h2>Conferences</h2>
                 <div class="news_widget">
                    <div class="news_date">2016-06-21</div>
                    <div class="news_content"><a href="http://preaction.me/">Doug Bell (preaction)</a> from <a href="http://chicago.pm.org/">Chicago.pm</a> will give an <a href="http://www.yapcna.org/yn2016/talk/6549">Introduction to Rex</a> talk at <a href="http://www.yapcna.org/yn2016/">YAPC::NA 2016</a>.</div>
                 </div>

               <h2>Need Help?</h2>
               <p>Rex is a pure open source project, you can find community support in the following places:</p>
               <ul>
                  <li>IRC: <a href="irc://irc.freenode.net/rex">#rex on irc.freenode.net</a></li>
                  <li>Groups: <a href="https://groups.google.com/group/rex-users/">Rex Users</a></li>
                  <li>Serverfault: <a href="http://serverfault.com/questions/tagged/rex">Tag with <i>rex</i></a></li>
                  <li>Issues: <a href="https://github.com/RexOps/Rex/issues">on GitHub</a></li>
                  <li>Feature: you miss a <a href="/care/help__r__ex.html">feature</a>?</li>
               </ul>
               <p><a href="/support/index.html">Professional support</a> is also available.</p>
            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/infrastructure/index.html">Infrastructure</a>
» <a href="/docs/rex_book/infrastructure/example_of_a_complete_rex_code_infrastructure.html">Example of a complete Rex code infrastructure</a>
</p>

              
              <h1>Example of a complete Rex code infrastructure</h1>
              <p>For maintainable and reusable code it is important to start with the right infrastructure choices and tools. In this chapter you will learn how to setup and design your project to achieve this.</p>

<p>You can find the code of this chapter on github.</p>

<ul>
<li>The service (example frontend service)</li>
<li>An example basic os module to configure the basics</li>
<li>An example ntp module</li>
</ul>

<h2 id="buildingservicesoutofblockswithrex">Building services out of blocks with Rex</h2>

<p>If you have a large environment with multiple services and a complex architecture it is important to design your code in a way that you can reuse most parts of it. To achieve this you need to follow some simple rules.</p>

<ul>
<li>Use a source control system like git.</li>
<li>Build modules for every part of your architecture. A module should be <strong>generic</strong> and should <strong>not contain</strong> any project specific logic or configuration. For example a module to manage apache or ntp.</li>
<li>Build services to tie the modules together. Services should hold <strong>all the project specific information</strong> need to build it.</li>
<li>The code of every module and every service should be in a separate code repository. With this it is easier to manage your infrastructure. You can create dependencies between services and modules on a branch level.</li>
<li>Use a CMDB to separate configuration from code.</li>
</ul>

<h3 id="sourcecontrolsystem">Source Control System</h3>

<p>Currently Rex supports only *git* for module and service repositories. So in this example i will use git.</p>

<p>To manage your git repositories i suggest some tool like Gitprep or Gitlab</p>

<h3 id="modules">Modules</h3>

<p>As mentioned above, you should separate your code. For better readability, usability and maintainability of your code this is important.</p>

<p>Modules must be generic. The modules are a bit like lego blocks. You can use lego blocks to build houses, ships, airplanes and much more. But the blocks are always the same.</p>

<h3 id="services">Services</h3>

<p>Services are a collection of modules. A service describe the system you want to build out of your module blocks.</p>

<h3 id="cmdb">CMDB</h3>

<p>Rex has a default CMDB build upon YAML files. Store all the service relevant configuration options inside your YAML file. If you do this you can be sure that your code will work even if you change something in the CMDB.</p>

<h2 id="examplefrontendservice">Example frontend service</h2>

<p>This is an example rex service.</p>

<h3 id="meta.yml-definedependencies">meta.yml - Define dependencies</h3>

<p>In the <strong>meta.yml</strong> file you can define some service information. The most important ones are the dependencies.</p>

<p>You can define dependencies to Rex modules and to Perl modules.</p>

<pre><code>Name: Frontend Service
Description: The frontend service
Author: jan gehring 
License: Apache 2.0
Require:
  Rex::NTP::Base:
    git: https://github.com/krimdomu/rex-ntp-base.git
    branch: master
  Rex::OS::Base:
    git: https://github.com/krimdomu/rex-os-base.git
    branch: master
PerlRequire:
  - Moo
</code></pre>

<p>In this file you see that we define some dependencies to custom Rex modules located in git repositories. The <code>rexify --resolve-deps</code> command will read the <strong>meta.yml</strong> file and download all these dependencies into the <strong>lib</strong> directory.</p>

<p>With this in mind it is easy to have multiple environments with the same service pointing to different development branches.</p>

<h3 id="rexfile-thecode">Rexfile - The code</h3>

<p>Every service has its own Rexfile.</p>

<h4 id="loadallrequiredmodules">Load all required modules</h4>

<pre><code class="hljs">⁠<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
⁠<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::CMDB</span>;
⁠<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Test</span>;
⁠<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Group</span>::<span class="hljs-function">Lookup</span>::<span class="hljs-function">INI</span>;</code></pre>

<p>These lines loads all required modules.</p>

<ul>
<li>Line 1: Load the basic Rex functions and enable all features from version 1.0 and above.</li>
<li>Line 2: Load the CMDB functions.</li>
<li>Line 3: Load the Rex::Test suite. With this you can test your Rex code with local virtual box virtual machines.</li>
<li>Line 4: Load the function to read Rex groups from ini files.</li>
</ul>

<h4 id="loadtheservergroups">Load the server groups</h4>

<pre><code class="hljs">⁠groups_file &quot;<span class="hljs-string">server.ini</span>&quot;;</code></pre>

<p>Load all server groups from the file <strong>server.ini</strong>.</p>

<h4 id="configurethecmdb">Configure the CMDB</h4>

<pre><code class="hljs">⁠set cmdb =&gt; {
⁠    type =&gt; &quot;<span class="hljs-string">YAML</span>&quot;,
⁠    path =&gt; [
⁠        &quot;<span class="hljs-string">cmdb/{operatingsystem}/{hostname}.yml</span>&quot;, &quot;<span class="hljs-string">cmdb/{operatingsystem}/default.yml</span>&quot;,
⁠        &quot;<span class="hljs-string">cmdb/{environment}/{hostname}.yml</span>&quot;,     &quot;<span class="hljs-string">cmdb/{environment}/default.yml</span>&quot;,
⁠        &quot;<span class="hljs-string">cmdb/{hostname}.yml</span>&quot;,                   &quot;<span class="hljs-string">cmdb/default.yml</span>&quot;,
⁠    ],
⁠};</code></pre>

<p>Configure the CMDB. Here we define a custom search path. This will tell the CMDB to lookup the keys in the following order:</p>

<ul>
<li>cmdb/{operatingsystem}/{hostname}.yml</li>
<li>cmdb/{operatingsystem}/default.yml</li>
<li>cmdb/{environment}/{hostname}.yml</li>
<li>cmdb/{environment}/default.yml</li>
<li>cmdb/{hostname}.yml</li>
<li>cmdb/default.yml</li>
</ul>

<p>It is possible to use every Rex::Hardware variable inside the path.</p>

<ul>
<li>environment (the environment defined by cli parameter -E)</li>
<li>server (the server name used to connect to the server)</li>
<li>kernelversion</li>
<li>kernelrelease</li>
<li>hostname</li>
<li>operatingsystem</li>
<li>operatingsystemrelease</li>
<li>architecture</li>
<li>domain</li>
<li>eth0_mac</li>
<li>eth0_ip</li>
<li>manufacturer</li>
<li>eth0_broadcast</li>
<li>eth0_netmask</li>
<li>and some others, too.</li>
</ul>

<h4 id="includeallrequiredrexmodules">Include all required Rex modules</h4>

<pre><code class="hljs">⁠include qw/
⁠  Rex::OS::Base
⁠  Rex::NTP::Base
⁠  /;</code></pre>

<p>Include all needed Rex modules. With <strong>include</strong> all the tasks inside these modules won&#39;t get displayed with <code>rex -T</code>.</p>

<h4 id="themaintask">The main task</h4>

<pre><code class="hljs">⁠task &quot;<span class="hljs-string">setup</span>&quot;,</code></pre>

<p>The main task. If you don&#39;t define the servers (or groups) in the task definition you can use the cli paramter -G or -H.</p>

<pre><code class="hljs">⁠task &quot;<span class="hljs-string">setup</span>&quot;, group =&gt; &quot;<span class="hljs-string">frontend</span>&quot;,</code></pre>

<p>It is also possible to define the server or group to connect to.</p>

<pre><code class="hljs">⁠make {
⁠    <span class="hljs-comment"># run setup() task of Rex::OS::Base module</span><span class="hljs-comment">
⁠</span>    <span class="hljs-function">Rex::OS</span>::<span class="hljs-function">Base</span>::<span class="hljs-function">setup</span>();
⁠
⁠    <span class="hljs-comment"># run setup() task of Rex::NTP::Base module</span><span class="hljs-comment">
⁠</span>    <span class="hljs-function">Rex::NTP</span>::<span class="hljs-function">Base</span>::<span class="hljs-function">setup</span>();
⁠};</code></pre>

<p>Inside the task we just call the tasks from the modules we have included above. All tasks can be called as a normal perl function, as long as the taskname doesn&#39;t conflict with other perl functions.</p>

<h4 id="thelastline">The last line</h4>

<pre><code class="hljs">⁠<span class="hljs-comment"># the last line of a Rexfile</span><span class="hljs-comment">
⁠</span><span class="hljs-number">1</span>;</code></pre>

<p>The last line of a Rexfile is normaly a true value. This is not always needed, but it is safer to include it.</p>

<h3 id="testbeforeship">Test before ship</h3>

<p>Since version 0.46 Rex comes with a integration test suite. It is based on Rex::Box and currently supports VirtualBox. With it you can spawn local Virtual Box VMs and test your tasks on it.</p>

<p>The tests are stored in the t directory.</p>

<h4 id="exampletbase.ttestfile">Example t/base.t test file</h4>

<pre><code class="hljs">⁠<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Test</span>::<span class="hljs-function">Base</span>;
⁠<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];</code></pre>

<p>Load the <strong>Rex::Test::Base</strong> framework and the Rex basic commands.</p>

<pre><code class="hljs">⁠test {
⁠    <span class="hljs-keyword">my</span> <span class="hljs-type">$t</span> = <span class="hljs-function">shift</span>;
⁠    <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">name</span>(&quot;<span class="hljs-string">ubuntu test</span>&quot;);
⁠
⁠    <span class="hljs-comment"># we will add more code here in a bit</span><span class="hljs-comment">
⁠</span>};
⁠<span class="hljs-number">1</span>;</code></pre>

<p>Create a new test named <strong>ubuntu test</strong>. For every test Rex will create a new vm.</p>

<pre><code class="hljs">⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">base_vm</span>(&quot;<span class="hljs-string">http://box.rexify.org/box/ubuntu-server-12.10-amd64.ova</span>&quot;);
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">vm_auth</span>( user =&gt; &quot;<span class="hljs-string">root</span>&quot;, password =&gt; &quot;<span class="hljs-string">box</span>&quot; );</code></pre>

<p>Define the url where to download the base VM image and the authentication.</p>

<pre><code class="hljs">⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">run_task</span>(&quot;<span class="hljs-string">setup</span>&quot;);</code></pre>

<p>Define which task to run on the VM.</p>

<pre><code class="hljs">⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_package</span>(&quot;<span class="hljs-string">vim</span>&quot;);
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_package</span>(&quot;<span class="hljs-string">ntp</span>&quot;);
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_package</span>(&quot;<span class="hljs-string">unzip</span>&quot;);
⁠  
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_file</span>(&quot;<span class="hljs-string">/etc/ntp.conf</span>&quot;);
⁠  
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_service_running</span>(&quot;<span class="hljs-string">ntp</span>&quot;);
⁠  
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">has_content</span>( &quot;<span class="hljs-string">/etc/passwd</span>&quot;, qr{root:x:0:}ms );
⁠  
⁠  run &quot;<span class="hljs-string">ls -l</span>&quot;;
⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">ok</span>( <span class="hljs-variable">$?</span> == 0, &quot;<span class="hljs-string">ls -l returns success.</span>&quot; );</code></pre>

<p>Run the tests. You can also use normal rex functions here.</p>

<p>At the end finish the tests with:</p>

<pre><code class="hljs">⁠  <span class="hljs-type">$t</span>-&gt;<span class="hljs-type">finish</span>;</code></pre>

<p>You can now run the tests with <code>rex Test:run</code>.</p>

<h3 id="gettingthecode">Getting the code</h3>

<p>Now, when you all have commit to your git repository you can use the rexify command to download them to (for example) a central deployment server.</p>

<pre><code>rexify --init=https://github.com/krimdomu/service-frontend.git
</code></pre>

<p>This will download everything into the folder <strong>service-frontend</strong>. The command also takes care of all dependencies and download them also into the <strong>lib</strong> folder.</p>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="http://preaction.me/statocles/">Statocles</a></p>
      <a href="https://groups.google.com/group/rex-users/">Google Group</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="http://www.freelists.org/list/rex-users">Mailinglist</a> / <a href="irc://irc.freenode.net/rex">irc.freenode.net #rex</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

   </body>

</html>
