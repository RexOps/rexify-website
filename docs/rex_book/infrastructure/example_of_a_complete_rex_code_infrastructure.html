<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title></title>

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/rexify-website/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/rexify-website/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/rexify-website/public/css/skin/rexify.org/bootstrap.min.css?20130325" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/rexify-website/public/css/skin/rexify.org/default.css?20140412" media="screen" rel="stylesheet" type="text/css">
      <script src="/rexify-website/public/js/skin/rexify.org/highlight.pack.js"></script>

      <style>
      </style>

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>Deployment &amp; Configuration Management</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/rexify-website/">Home</a></li>
    <li><a href="/rexify-website/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/rexify-website/care/index.html" title="care">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/rexify-website/care/help__r__ex.html">Help Rex</a></li>
          <li><a href="/rexify-website/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/rexify-website/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/rexify-website/docs/index.html" title="docs">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="docs/faq/index.html">FAQ</a></li>
          <li><a href="docs/guides/index.html">Guides</a></li>
          <li><a href="docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="docs/other/index.html">Other</a></li>
          <li><a href="docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="docs/api/index.html">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>Search</h2>
               <form action="/search.html" method="GET">
                  <input class="search_field" id="q" name="q" type="text"><button class="btn">Go</button>
               </form>
               <h2>News</h2>

               <!-- % my $news_o = $site->get_page(11); -->
               <!-- % for my $news_item ($news_o->children({"me.active" => 1, "me.hidden" => 0})) { -->
               <!-- % my ($news_date) = split(/ /, $news_item->data->{news_date}); -->
               <!--   <div class="news_widget"> -->
               <!--   </div> -->

               <!-- % } -->


               <h2>Conferences</h2>
                 <div class="news_widget">
                    <div class="news_date">2016-06-21</div>
                    <div class="news_content"><a href="http://preaction.me/">Doug Bell (preaction)</a> from <a href="http://chicago.pm.org/">Chicago.pm</a> will give an <a href="http://www.yapcna.org/yn2016/talk/6549">Introduction to Rex</a> talk at <a href="http://www.yapcna.org/yn2016/">YAPC::NA 2016</a>.</div>
                 </div>

               <h2>Training</h2>

               <!-- % for my $training_item (@{$app->{data}{trainings}}) { -->
               <!--   <div class="news_widget"> -->
               <!--   </div> -->

               <!-- % } -->



               <h2>Need Help?</h2>
               <p>Rex is a pure open source project, you can find community support in the following places:</p>
               <ul>
                  <li>IRC: <a href="irc://irc.freenode.net/rex">#rex on irc.freenode.net</a></li>
                  <li>Groups: <a href="https://groups.google.com/group/rex-users/">Rex Users</a></li>
                  <li>Serverfault: <a href="http://serverfault.com/questions/tagged/rex">Tag with <i>rex</i></a></li>
                  <li>Issues: <a href="https://github.com/RexOps/Rex/issues">on GitHub</a></li>
                  <li>Feature: you miss a <a href="/rexify-website/feature.html">feature</a>?</li>
               </ul>
               <p><a href="/rexify-website/support/index.html">Professional support</a> is also available.</p>
            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
              <!-- %= include 'skin/rexify.org/_breadcrumb.html.ep'; -->
              
              <p>For maintainable and reusable code it is important to start with the right infrastructure choices and tools. In this chapter you will learn how to setup and design your project to achieve this.</p>

<p>You can find the code of this chapter on github.</p>

<ul>
<li>The service (example frontend service)</li>
<li>An example basic os module to configure the basics</li>
<li>An example ntp module</li>
</ul>

<h2>Building services out of blocks with Rex</h2>

<p>If you have a large environment with multiple services and a complex architecture it is important to design your code in a way that you can reuse most parts of it. To achieve this you need to follow some simple rules.</p>

<ul>
<li>Use a source control system like git.</li>
<li>Build modules for every part of your architecture. A module should be <strong>generic</strong> and should <strong>not contain</strong> any project specific logic or configuration. For example a module to manage apache or ntp.</li>
<li>Build services to tie the modules together. Services should hold <strong>all the project specific information</strong> need to build it.</li>
<li>The code of every module and every service should be in a separate code repository. With this it is easier to manage your infrastructure. You can create dependencies between services and modules on a branch level.</li>
<li>Use a CMDB to separate configuration from code.</li>
</ul>

<h3>Source Control System</h3>

<p>Currently Rex supports only *git* for module and service repositories. So in this example i will use git.</p>

<p>To manage your git repositories i suggest some tool like Gitprep or Gitlab</p>

<h3>Modules</h3>

<p>As mentioned above, you should separate your code. For better readability, usability and maintainability of your code this is important.</p>

<p>Modules must be generic. The modules are a bit like lego blocks. You can use lego blocks to build houses, ships, airplanes and much more. But the blocks are always the same.</p>

<h3>Services</h3>

<p>Services are a collection of modules. A service describe the system you want to build out of your module blocks.</p>

<h3>CMDB</h3>

<p>Rex has a default CMDB build upon YAML files. Store all the service relevant configuration options inside your YAML file. If you do this you can be sure that your code will work even if you change something in the CMDB.</p>

<h2>Example frontend service</h2>

<p>This is an example rex service.</p>

<h3>meta.yml - Define dependencies</h3>

<p>In the <strong>meta.yml</strong> file you can define some service information. The most important ones are the dependencies.</p>

<p>You can define dependencies to Rex modules and to Perl modules.</p>

<pre><code>Name: Frontend Service
Description: The frontend service
Author: jan gehring 
License: Apache 2.0
Require:
  Rex::NTP::Base:
    git: https://github.com/krimdomu/rex-ntp-base.git
    branch: master
  Rex::OS::Base:
    git: https://github.com/krimdomu/rex-os-base.git
    branch: master
PerlRequire:
  - Moo
</code></pre>

<p>In this file you see that we define some dependencies to custom Rex modules located in git repositories. The <code>rexify --resolve-deps</code> command will read the <strong>meta.yml</strong> file and download all these dependencies into the <strong>lib</strong> directory.</p>

<p>With this in mind it is easy to have multiple environments with the same service pointing to different development branches.</p>

<h3>Rexfile - The code</h3>

<p>Every service has its own Rexfile.</p>

<h4>Load all required modules</h4>

<pre><code>use Rex -feature =&gt; [&#39;1.0&#39;];
use Rex::CMDB;
use Rex::Test;
use Rex::Group::Lookup::INI;
</code></pre>

<p>These lines loads all required modules.</p>

<ul>
<li>Line 1: Load the basic Rex functions and enable all features from version 1.0 and above.</li>
<li>Line 2: Load the CMDB functions.</li>
<li>Line 3: Load the Rex::Test suite. With this you can test your Rex code with local virtual box virtual machines.</li>
<li>Line 4: Load the function to read Rex groups from ini files.</li>
</ul>

<h4>Load the server groups</h4>

<pre><code>groups_file &quot;server.ini&quot;;
</code></pre>

<p>Load all server groups from the file <strong>server.ini</strong>.</p>

<h4>Configure the CMDB</h4>

<pre><code>set cmdb =&gt; {
  type =&gt; &quot;YAML&quot;,
  path =&gt; [
    &quot;cmdb/{operatingsystem}/{hostname}.yml&quot;,
    &quot;cmdb/{operatingsystem}/default.yml&quot;,
    &quot;cmdb/{environment}/{hostname}.yml&quot;,
    &quot;cmdb/{environment}/default.yml&quot;,
    &quot;cmdb/{hostname}.yml&quot;,
    &quot;cmdb/default.yml&quot;,
  ],
};
</code></pre>

<p>Configure the CMDB. Here we define a custom search path. This will tell the CMDB to lookup the keys in the following order:</p>

<ul>
<li>cmdb/{operatingsystem}/{hostname}.yml</li>
<li>cmdb/{operatingsystem}/default.yml</li>
<li>cmdb/{environment}/{hostname}.yml</li>
<li>cmdb/{environment}/default.yml</li>
<li>cmdb/{hostname}.yml</li>
<li>cmdb/default.yml</li>
</ul>

<p>It is possible to use every Rex::Hardware variable inside the path.</p>

<ul>
<li>environment (the environment defined by cli parameter -E)</li>
<li>server (the server name used to connect to the server)</li>
<li>kernelversion</li>
<li>kernelrelease</li>
<li>hostname</li>
<li>operatingsystem</li>
<li>operatingsystemrelease</li>
<li>architecture</li>
<li>domain</li>
<li>eth0_mac</li>
<li>eth0_ip</li>
<li>manufacturer</li>
<li>eth0_broadcast</li>
<li>eth0_netmask</li>
<li>and some others, too.</li>
</ul>

<h4>Include all required Rex modules</h4>

<pre><code>include qw/
  Rex::OS::Base
  Rex::NTP::Base
  /;
</code></pre>

<p>Include all needed Rex modules. With <strong>include</strong> all the tasks inside these modules won&#39;t get displayed with <code>rex -T</code>.</p>

<h4>The main task</h4>

<pre><code>task &quot;setup&quot;,
</code></pre>

<p>The main task. If you don&#39;t define the servers (or groups) in the task definition you can use the cli paramter -G or -H.</p>

<pre><code>task &quot;setup&quot;, group =&gt; &quot;frontend&quot;,
</code></pre>

<p>It is also possible to define the server or group to connect to.</p>

<pre><code>make {
  # run setup() task of Rex::OS::Base module
  Rex::OS::Base::setup();

  # run setup() task of Rex::NTP::Base module
  Rex::NTP::Base::setup();
};
</code></pre>

<p>Inside the task we just call the tasks from the modules we have included above. All tasks can be called as a normal perl function, as long as the taskname doesn&#39;t conflict with other perl functions.</p>

<h4>The last line</h4>

<pre><code># the last line of a Rexfile
1;
</code></pre>

<p>The last line of a Rexfile is normaly a true value. This is not always needed, but it is safer to include it.</p>

<h3>Test before ship</h3>

<p>Since version 0.46 Rex comes with a integration test suite. It is based on Rex::Box and currently supports VirtualBox. With it you can spawn local Virtual Box VMs and test your tasks on it.</p>

<p>The tests are stored in the t directory.</p>

<h4>Example t/base.t test file</h4>

<pre><code>use Rex::Test::Base;
use Rex -feature =&gt; [&#39;1.0&#39;];
</code></pre>

<p>Load the <strong>Rex::Test::Base</strong> framework and the Rex basic commands.</p>

<pre><code>test {
  my $t = shift;
  $t-&gt;name(&quot;ubuntu test&quot;);
</code></pre>

<p>Create a new test named <strong>ubuntu test</strong>. For every test Rex will create a new vm.</p>

<pre><code>  $t-&gt;base_vm(&quot;http://box.rexify.org/box/ubuntu-server-12.10-amd64.ova&quot;);
  $t-&gt;vm_auth(user =&gt; &quot;root&quot;, password =&gt; &quot;box&quot;);
</code></pre>

<p>Define the url where to download the base VM image and the authentication.</p>

<pre><code>  $t-&gt;run_task(&quot;setup&quot;);
</code></pre>

<p>Define which task to run on the VM.</p>

<pre><code>  $t-&gt;has_package(&quot;vim&quot;);
  $t-&gt;has_package(&quot;ntp&quot;);
  $t-&gt;has_package(&quot;unzip&quot;);

  $t-&gt;has_file(&quot;/etc/ntp.conf&quot;);

  $t-&gt;has_service_running(&quot;ntp&quot;);

  $t-&gt;has_content(&quot;/etc/passwd&quot;, qr{root:x:0:}ms);

  run &quot;ls -l&quot;;
  $t-&gt;ok($? == 0, &quot;ls -l returns success.&quot;);
</code></pre>

<p>Run the tests. You can also use normal rex functions here.</p>

<p>At the end finish the tests with:</p>

<pre><code>  $t-&gt;finish;
};
1;
</code></pre>

<p>You can now run the tests with <code>rex Test:run</code>.</p>

<h3>Getting the code</h3>

<p>Now, when you all have commit to your git repository you can use the rexify command to download them to (for example) a central deployment server.</p>

<pre><code>rexify --init=https://github.com/krimdomu/service-frontend.git
</code></pre>

<p>This will download everything into the folder <strong>service-frontend</strong>. The command also takes care of all dependencies and download them also into the <strong>lib</strong> folder.</p>




            </div>
         </div> <!-- content -->

       <!-- page -->


     <a href="http://github.com/RexOps/Rex"><img alt="Fork me on GitHub" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" style="position: absolute; top: 0; right: 0; border: 0;"></a>

   <div class="clearfix"></div>
   <div class="bottom_bar">
      <a href="https://groups.google.com/group/rex-users/">Google Group</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="http://www.freelists.org/list/rex-users">Mailinglist</a> / <a href="irc://irc.freenode.net/rex">irc.freenode.net #rex</a><span id="syntax_high" style="display: none;"> / <a href="#" id="link_syntax_high">Enable Syntax Highlighting</a></span>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

   <script charset="utf-8" src="/rexify-website/public/js/skin/rexify.org/jquery.js" type="text/javascript"></script>
   <script charset="utf-8" src="/rexify-website/public/js/skin/rexify.org/bootstrap.min.js" type="text/javascript"></script>
   <script charset="utf-8" src="/rexify-website/public/js/skin/rexify.org/menu.js" type="text/javascript"></script>
   <script charset="utf-8" src="/rexify-website/public/js/skin/rexify.org/ZeroClipboard.min.js" type="text/javascript"></script>

   <script>
      var client = new ZeroClipboard($(".copy-button"), { moviePath: "/public/js/skin/rexify.org/ZeroClipboard.swf"});
   </script>

   <script>
      if($(window).width() <= 1100) {
         // hide API link
         $("#li_api").hide();
      }
      $(window).on('resize', function() {
       if($(window).width() <= 1100) {
         // hide API link
         $("#li_api").hide();
       }
       else {
         $("#li_api").show();
       }

      });
   </script>


<script src="/rexify-website/public/js/skin/rexify.org/browser.js"></script>
<script>
  hljs.tabReplace = '    ';
//  hljs.initHighlighting();
  hljs.initHighlightingOnLoad();
</script>


   </body>

</html>
