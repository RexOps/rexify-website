<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Working with Files</title>

      <meta content="Working with Files" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://rexify.org/docs/rex_book/working_with_files_and_packages/working_with_files.html" property="og:url">
      <meta content="https://rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2021-07-05</b><br>
                     <a href="/blog/2021/07/05/rex-1.13.4.html">Rex-1.13.4</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.4.html">Rex-1.13.4 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.4">available on CPAN</a>. It contains documentation updates, and a fix for inconsistent behavior between the <code>content</code> and <code>source</code> options of the file command.</p>

                   <p><b>2021-03-05</b><br>
                     <a href="/blog/2021/03/05/rex-1.13.3.html">Rex-1.13.3</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.3.html">Rex-1.13.3 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.3">available on CPAN</a>. It contains documentation updates, and a fix for debconf parsing. Behind the scenes, CI was migrated over to GitHub Actions as well.</p>

                   <p><b>2020-12-05</b><br>
                     <a href="/blog/2020/12/05/rex-1.13.2.html">Rex-1.13.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.2.html">Rex-1.13.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.2">available on CPAN</a>. It contains only documentation updates, mostly for the built-in template capabilities, but also fixes a few typos.</p>

                   <p><b>2020-11-05</b><br>
                     <a href="/blog/2020/11/05/rex-1.13.1.html">Rex-1.13.1</a></p><p>
                   </p><p></p><p><a href="https://github.com/RexOps/Rex/commit/cabbc6a8aa9eb2c0d9d3fc2439be51924edc3ff8">Happy 10th birthday, Rex!</a></p>

<p>The <a href="/docs/release_notes/1.13.1.html">Rex-1.13.1 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.1">available on CPAN</a>. It is focusing on CMDB bugfixes and documentation, while also fixing a missing feature flag. Upgrade is recommended for all users.</p>

                   <p><b>2020-10-05</b><br>
                     <a href="/blog/2020/10/05/rex-1.13.0.html">Rex-1.13.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.13.0.html">Rex-1.13.0 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.13.0">available on CPAN</a>. It adds <code>on_no_change</code> hooks for file management commands to trigger further actions when files are left unchanged. Upgrade is recommended for all users.</p>


               <h2>Events</h2>
                   <p><b>2021-03-08</b><br>
                     <a href="/blog/2021/03/04/learn_automation_using_rex.html">Learning automation using Rex</a></p><p>
                   </p><p></p><p>Ferenc Erki (FErki) will be the guest of <a href="https://www.linkedin.com/in/szabgab/">Gábor Szabó</a> on the next Code Maven live stream to learn about automation using Rex. Register for the free event via <a href="https://code-maven.com/automation-with-rex">Code Maven</a> or <a href="https://www.meetup.com/Code-Mavens/events/276730377/">Meetup</a>, and join the discussion!</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/unexpected_use_cases_with_rex.html">Unexpected use cases with Rex</a></p><p>
                   </p><p></p><p><a href="https://act.yapc.eu/gpw2020/talk/7699">Unexpected use cases with Rex</a> at the <a href="https://act.yapc.eu/gpw2020/index.html">22nd German Perl/Raku Workshop 2020</a> in Erlangen by Ferenc Erki (FErki).</p>

                   <p><b>2019-11-09</b><br>
                     <a href="/blog/2019/11/09/rex_and_friends_2019.html">Rex &amp; Friends</a></p><p>
                   </p><p></p><p><a href="https://friends.barcelona.pm/2019/#/talks/rex-and-friends">Rex &amp; Friends</a> talk at the <a href="https://friends.barcelona.pm">Barcelona Perl &amp; Friends 2019</a> by Ferenc Erki (FErki).</p>


            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/working_with_files_and_packages/index.html">Working with files and packages</a>
» <a href="/docs/rex_book/working_with_files_and_packages/working_with_files.html">Working with Files</a>
</p>

              
              <h1>Working with Files</h1>
              <p>One task in configuration management is managing files and keeping them in a consistent state. Rex gives you some easy to use functions to work with files.</p>

<h2 id="simplechanges">Simple changes</h2>

<p>If you need to verify that a given line exists or gets removed from a file you can use append_if_no_such_line and delete_lines_according_to.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span>task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    append_if_no_such_line &quot;<span class="hljs-string">/etc/modules</span>&quot;, &quot;<span class="hljs-string">loop</span>&quot;;
};</code></pre>

<p>This code will just append the line loop to /etc/modules if it doesn&#39;t exists.</p>

<h3 id="usingregularexpressiontomatchtheline">Using regular expression to match the line</h3>

<p>It is also possible to define more complex rules. For example if you want to use a regular expression.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span>task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    append_if_no_such_line &quot;<span class="hljs-string">/etc/modprobe.d/thinkfan.conf</span>&quot;,
      line   =&gt; &quot;<span class="hljs-string">options thinkpad_acpi fan_control=1</span>&quot;,
      regexp =&gt; qr{thinkpad_acpi};
};</code></pre>

<h3 id="usingatemplateandexecutingextracodeifthefilechanged">Using a template and executing extra code if the file changed</h3>

<p>If you need to add more than one line to a file or need to add dynamic content to it, you can also use the template() function to do this.</p>

<p>You can also execute code if the file was changed, for example to restart services.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span>task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    append_if_no_such_line &quot;<span class="hljs-string">/etc/nagios/hosts.d/frontends.cfg</span>&quot;,
      line      =&gt; template( &quot;<span class="hljs-string">templates/nagios/host.cfg.tpl</span>&quot;, <span class="hljs-type">%tpl_variables</span> ),
      regexp    =&gt; qr/<span class="hljs-number">\s</span><span class="hljs-string">*</span>host_name<span class="hljs-number">\s</span><span class="hljs-string">*</span><span class="hljs-type">$host</span>/,
      on_change =&gt; <span class="hljs-keyword">sub </span>{ service nagios =&gt; &quot;<span class="hljs-string">reload</span>&quot;; };
};</code></pre>

<h3 id="deletinglines">Deleting lines</h3>

<p>If you need to remove a line you can use delete_lines_according_to.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span>task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    delete_lines_according_to qr{loop}, &quot;<span class="hljs-string">/etc/modules</span>&quot;,
      on_change =&gt; <span class="hljs-keyword">sub </span>{ say &quot;<span class="hljs-string">file was modified.</span>&quot;; };
};</code></pre>

<h2 id="managingfileswithsnippets">Managing files with snippets</h2>

<p>Sometimes you need to create large configuration files because you don&#39;t have the ability to use conf.d folders.</p>

<p>You can do this by creating the snippets and concatenating them at the end.</p>

<p>For this you can use the Rex::Commands::Concat module from http://modules.rexify.org/module/Rex::Commands::Concat.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Commands</span>::<span class="hljs-function">Concat</span>;

task &quot;<span class="hljs-string">prepare</span>&quot;, <span class="hljs-keyword">sub </span>{
    concat_fragment &quot;<span class="hljs-string">config-header</span>&quot;,
      target  =&gt; &quot;<span class="hljs-string">/etc/some.conf</span>&quot;,
      content =&gt; &quot;<span class="hljs-string"># managed by Rex</span><span class="hljs-string">\n</span>&quot;,
      order   =&gt; &quot;<span class="hljs-string">01</span>&quot;;

    concat_fragment &quot;<span class="hljs-string">listen-entry</span>&quot;,
      target  =&gt; &quot;<span class="hljs-string">/etc/some.conf</span>&quot;,
      content =&gt; &quot;<span class="hljs-string">Listen *:80</span><span class="hljs-string">\n</span>&quot;,
      order   =&gt; &quot;<span class="hljs-string">20</span>&quot;;
};

task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    concat &quot;<span class="hljs-string">/etc/some.conf</span>&quot;,
      ensure    =&gt; &quot;<span class="hljs-string">present</span>&quot;,
      owner     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode      =&gt; <span class="hljs-number">644</span>,
      on_change =&gt; <span class="hljs-keyword">sub </span>{ say &quot;<span class="hljs-string">changed...</span>&quot;; };
};</code></pre>

<p>You can create as many concat_fragment() as you need. And you can create them anywhere you want. At the end of your code you have to call the concat() resource to generate the file out of all the fragments that have been written so far.</p>

<h2 id="thefileresource">The file() resource</h2>

<p>If you want to manage complete files you can use the file() resource to do so. The file() resource supports also setting the permissions and executing actions for changes.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    file &quot;<span class="hljs-string">/etc/my.conf</span>&quot;, source =&gt; &quot;<span class="hljs-string">files/etc/my.conf</span>&quot;;
};</code></pre>

<p>This example will just upload the file files/etc/my.conf to the server and stores it at /etc/my.conf.</p>

<p>You can also define the permissions for the file.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    file &quot;<span class="hljs-string">/etc/my.conf</span>&quot;,
      source =&gt; &quot;<span class="hljs-string">files/etc/my.conf</span>&quot;,
      owner  =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group  =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode   =&gt; <span class="hljs-number">600</span>;
};</code></pre>

<p>If you want to execute a command when the file was changed, you can use the on_change option.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    file &quot;<span class="hljs-string">/etc/my.conf</span>&quot;,
      source    =&gt; &quot;<span class="hljs-string">files/etc/my.conf</span>&quot;,
      owner     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode      =&gt; <span class="hljs-number">600</span>,
      on_change =&gt; <span class="hljs-keyword">sub </span>{ service mysqld =&gt; &quot;<span class="hljs-string">restart</span>&quot;; };
};</code></pre>

<p>This will restart the mysqld service if the file was modified.</p>

<h3 id="supervisingfiles">Supervising files</h3>

<p>It is also possible to just supervise files if they are present or have special permissions. To do this, just create the file() resource without the source or content parameter.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

task &quot;<span class="hljs-string">setup</span>&quot;, <span class="hljs-keyword">sub </span>{
    file &quot;<span class="hljs-string">/etc/my.conf</span>&quot;,
      ensure =&gt; &quot;<span class="hljs-string">present</span>&quot;,
      owner  =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group  =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode   =&gt; <span class="hljs-number">600</span>;
};</code></pre>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="http://preaction.me/statocles/">Statocles</a></p>
      <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="https://matrix.to/#rexops:matrix.org">Matrix</a> / <a href="https://webchat.oftc.net/?channels=rexops">IRC</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://groups.google.com/group/rex-users/">Google Groups</a> / <a href="https://stackshare.io/rex">StackShare</a> / <a href="http://www.freelists.org/list/rex-users">Mailing list</a> / <a href="http://serverfault.com/questions/tagged/rex">Server Fault</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

   </body>

</html>
