<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Using Environments</title>

      <meta content="Using Environments" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://www.rexify.org/docs/rex_book/the_rex_dsl/using_environments.html" property="og:url">
      <meta content="https://www.rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2025-07-05</b><br>
                     <a href="/blog/2025/07/05/rex-1.16.1.html">Rex-1.16.1</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.16.1.html">Rex-1.16.1</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.16.1">available on
CPAN</a>.</p>

<p>It delivers bug fixes for hostgroup membership lists, executable discovery
without <code>which</code>, and many others on BSDs and Solaris, including discovering
memory usage details.</p>

                   <p><b>2025-02-05</b><br>
                     <a href="/blog/2025/02/05/rex-1.16.0.html">Rex-1.16.0</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.16.0.html">Rex-1.16.0</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.16.0">available on
CPAN</a>.</p>

<p>It now requires at least perl-5.14.4 to install, contains new features for
running commands on Windows, and fixes bugs around git repository branch
operations.</p>

                   <p><b>2024-11-05</b><br>
                     <a href="/blog/2024/11/05/rex-1.15.0.html">Rex-1.15.0</a></p><p>
                   </p><p></p><p><a href="https://github.com/RexOps/Rex/commit/cabbc6a8aa9eb2c0d9d3fc2439be51924edc3ff8">Happy 14th birthday, Rex!</a></p>

<p><a href="/docs/release_notes/1.15.0.html">Rex-1.15.0</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.15.0">available on CPAN</a>. It contains several bug fixes and a few new features.</p>

                   <p><b>2023-08-05</b><br>
                     <a href="/blog/2023/08/05/rex-1.14.3.html">Rex-1.14.3</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.14.3.html">Rex-1.14.3</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.3">available on CPAN</a>. It contains bug fixes for local package installation, command existence checks, and Git tests.</p>

                   <p><b>2023-05-05</b><br>
                     <a href="/blog/2023/05/05/rex-1.14.2.html">Rex-1.14.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.14.2.html">Rex-1.14.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.2">available on CPAN</a>. It contains bug fixes for running local commands on Windows, cloning git repositories, and test suite fixes for the upcoming perl-5.38.0 release.</p>


               <h2>Events</h2>
                   <p><b>2021-03-08</b><br>
                     <a href="/blog/2021/03/04/learn_automation_using_rex.html">Learning automation using Rex</a></p><p>
                   </p><p></p><p>Ferenc Erki (FErki) will be the guest of <a href="https://www.linkedin.com/in/szabgab/">Gábor Szabó</a> on the next Code Maven live stream to learn about automation using Rex. Register for the free event via <a href="https://code-maven.com/automation-with-rex">Code Maven</a> or <a href="https://www.meetup.com/Code-Mavens/events/276730377/">Meetup</a>, and join the discussion!</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/unexpected_use_cases_with_rex.html">Unexpected use cases with Rex</a></p><p>
                   </p><p></p><p><a href="https://act.yapc.eu/gpw2020/talk/7699">Unexpected use cases with Rex</a> at the <a href="https://act.yapc.eu/gpw2020/index.html">22nd German Perl/Raku Workshop 2020</a> in Erlangen by Ferenc Erki (FErki).</p>

                   <p><b>2019-11-09</b><br>
                     <a href="/blog/2019/11/09/rex_and_friends_2019.html">Rex &amp; Friends</a></p><p>
                   </p><p></p><p><a href="https://friends.barcelona.pm/2019/#/talks/rex-and-friends">Rex &amp; Friends</a> talk at the <a href="https://friends.barcelona.pm">Barcelona Perl &amp; Friends 2019</a> by Ferenc Erki (FErki).</p>


            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/the_rex_dsl/index.html">The rex dsl</a>
» <a href="/docs/rex_book/the_rex_dsl/using_environments.html">Using Environments</a>
</p>

              
              <h1>Using Environments</h1>
              <p>With environments it is easy to group your servers depending on the maturity of your configuration or your code.</p>

<p>You can create environments for dev, staging and production machines. There is no limit for environments, so you can create as much as you need.</p>

<p>The classic way is to have 3 environments. The development environment for integration tests, mostly with fewest machines. The staging environment, mostly with the same resource layers as production. And the production environment.</p>

<p><img alt="Environments" height="464" src="/public/images/skin/rexify.org/book_env.png" width="619"></p>

<h2 id="creatingenvironments">Creating Environments</h2>

<p>Creating environments is as easy as creating groups. To create environments you can use the environment function. Inside an environment you can place everything that is specific for this environment (like authentication, server groups, tasks, ...).</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];

environment test =&gt; <span class="hljs-keyword">sub </span>{
    user &quot;<span class="hljs-string">root</span>&quot;;
    password &quot;<span class="hljs-string">b0x</span>&quot;;

    group frontend   =&gt; &quot;<span class="hljs-string">fe01.test</span>&quot;;
    group middleware =&gt; &quot;<span class="hljs-string">mw01.test</span>&quot;;
    group dbwrite    =&gt; &quot;<span class="hljs-string">dbm01.test</span>&quot;;
};

environment stage =&gt; <span class="hljs-keyword">sub </span>{
    user &quot;<span class="hljs-string">root</span>&quot;;
    password &quot;<span class="hljs-string">b0xst4g3</span>&quot;;

    group loadbalancer =&gt; &quot;<span class="hljs-string">lb01.stage</span>&quot;;
    group frontend     =&gt; &quot;<span class="hljs-string">fe01.stage</span>&quot;;
    group middleware   =&gt; &quot;<span class="hljs-string">mw01.stage</span>&quot;;
    group dbread       =&gt; &quot;<span class="hljs-string">dbs01.stage</span>&quot;;
    group dbwrite      =&gt; &quot;<span class="hljs-string">dbm01.stage</span>&quot;;
};

environment live =&gt; <span class="hljs-keyword">sub </span>{
    user &quot;<span class="hljs-string">admin</span>&quot;;
    password &quot;<span class="hljs-string">b0xl1v3</span>&quot;;
    sudo_password &quot;<span class="hljs-string">b0xl1v3</span>&quot;;
    sudo TRUE;

    group loadbalancer =&gt; &quot;<span class="hljs-string">lb[01..02].live</span>&quot;;
    group frontend     =&gt; &quot;<span class="hljs-string">fe[01..03].live</span>&quot;;
    group middleware   =&gt; &quot;<span class="hljs-string">mw[01..02].live</span>&quot;;
    group dbread       =&gt; &quot;<span class="hljs-string">dbs[01..02].live</span>&quot;;
    group dbwrite      =&gt; &quot;<span class="hljs-string">dbm01.live</span>&quot;;
};</code></pre>

<h2 id="runningtasks">Running tasks</h2>

<p>To run the task inside a special environment you have to use the cli option -E</p>

<pre><code>$ rex -E stage $task
</code></pre>

<p>If you need to configure systems depending on the environment you can get the current environment inside a task with the environment function.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span>task &quot;<span class="hljs-string">prepare</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">frontend</span>&quot;,
  make {
    <span class="hljs-comment"># configure ntp.conf depending on the environment</span><span class="hljs-comment">
</span>    <span class="hljs-keyword">my</span> <span class="hljs-type">$ntp_server</span> = case environment, {
        test      =&gt; [&quot;<span class="hljs-string">ntp01.test</span>&quot;],
          stage   =&gt; [&quot;<span class="hljs-string">ntp01.stage</span>&quot;],
          live    =&gt; [ &quot;<span class="hljs-string">ntp01.live</span>&quot;, &quot;<span class="hljs-string">ntp02.live</span>&quot; ],
          default =&gt; [&quot;<span class="hljs-string">ntp01.test</span>&quot;],
    };

    file &quot;<span class="hljs-string">/etc/ntp.conf</span>&quot;,
      content   =&gt; template( &quot;<span class="hljs-string">templates/etc/ntp.conf</span>&quot;, ntp_server =&gt; <span class="hljs-type">$ntp_server</span> ),
      owner     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode      =&gt; <span class="hljs-number">644</span>,
      on_change =&gt; make { service ntpd =&gt; &quot;<span class="hljs-string">restart</span>&quot;; };
  };</code></pre>

<h2 id="environmentsandthecmdb">Environments and the CMDB</h2>

<p>If you&#39;re using a CMDB to separate data from code you can also create YAML files for the different environments.</p>

<p>The lookup path for the default YAML CMDB is as follow:</p>

<ul>
<li>$server.yml</li>
<li>$environment/$server.yml</li>
<li>$environment/default.yml</li>
<li>default.yml</li>
</ul>

<h3 id="theyamlfiles">The YAML files</h3>

<pre><code># File: cmdb/default.yml
ntp_server:
  - ntp01.test

# File: cmdb/test/default.yml
ntp_server:
  - ntp01.test

# File: cmdb/stage/default.yml
ntp_server:
  - ntp01.stage

# File: cmdb/live/default.yml
ntp_server:
  - ntp01.live
  - ntp02.live
</code></pre>

<h3 id="therexfile">The Rexfile</h3>

<p>To use the CMDB you have to require and configure the Rex::CMDB module first.</p>

<pre><code class="hljs"><span class="hljs-comment"># Rexfile</span><span class="hljs-comment">
</span><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::CMDB</span>;

set cmdb =&gt; {
    type =&gt; &quot;<span class="hljs-string">YAML</span>&quot;,
    path =&gt; &quot;<span class="hljs-string">./cmdb</span>&quot;,
};

task &quot;<span class="hljs-string">prepare</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">frontend</span>&quot;,
  make {
    <span class="hljs-comment"># configure ntp.conf depending on the environment</span><span class="hljs-comment">
</span>    <span class="hljs-keyword">my</span> <span class="hljs-type">$ntp_server</span> = get cmdb &quot;<span class="hljs-string">ntp_server</span>&quot;;

    file &quot;<span class="hljs-string">/etc/ntp.conf</span>&quot;,
      content   =&gt; template( &quot;<span class="hljs-string">templates/etc/ntp.conf</span>&quot;, ntp_server =&gt; <span class="hljs-type">$ntp_server</span> ),
      owner     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      group     =&gt; &quot;<span class="hljs-string">root</span>&quot;,
      mode      =&gt; <span class="hljs-number">644</span>,
      on_change =&gt; make { service ntpd =&gt; &quot;<span class="hljs-string">restart</span>&quot;; };
  };</code></pre>

<p>Now you can run the task with <code>rex -E test prepare</code>.</p>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="https://www.perl.org/">Perl</a> and built with <a href="http://preaction.me/statocles/">Statocles</a></p>
      <p>GitHub <a href="https://github.com/RexOps/Rex">repository</a> and <a href="https://github.com/RexOps/Rex/discussions">discussions</a> / Chat on <a href="https://matrix.to/#/#rexops:matrix.org">Matrix</a> and <a href="https://webchat.oftc.net/?channels=rexops">IRC</a> / Mailing list on <a href="https://groups.google.com/group/rex-users/">Google Groups</a> (retired: <a href="http://www.freelists.org/list/rex-users">rex-users@freelists</a>)</p>
      <p><a href="https://metacpan.org/dist/Rex">MetaCPAN</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://stackshare.io/rex">StackShare</a> / <a href="http://serverfault.com/questions/tagged/rex">Server Fault</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a></p>
   </div>

   </body>

</html>
