<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Using Environments</title>

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css?20130325" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css?20140412" media="screen" rel="stylesheet" type="text/css">
      <script src="/public/js/skin/rexify.org/highlight.pack.js"></script>
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>Deployment &amp; Configuration Management</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/other/index.html">Other</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2019-06-09</b><br>
                     <a href="/blog/2019/06/09/site-update.html">Post-migration updates &amp; clean-up</a></p><p>
                   </p><p></p><p>Over the course of the past weeks many clean-ups have been
done, reaping the benefits provided by our new
<a href="https://preaction.me/statocles">Statocles</a>-based site:</p>

                   <p><b>2019-05-19</b><br>
                     <a href="/blog/2019/05/19/new-site.html">New site engine for rexify.org</a></p><p>
                   </p><p></p><p>After months of work on a new site backend, we reached the MVP today for
our site to be switched over to a new engine: from now on, our site will be
maintained using the static site generator
<a href="http://preaction.me/statocles/">Statocles</a>.</p>


               <h2>Conferences</h2>
                 <div class="news_widget">
                    <div class="news_date">2016-06-21</div>
                    <div class="news_content"><a href="http://preaction.me/">Doug Bell (preaction)</a> from <a href="http://chicago.pm.org/">Chicago.pm</a> will give an <a href="http://www.yapcna.org/yn2016/talk/6549">Introduction to Rex</a> talk at <a href="http://www.yapcna.org/yn2016/">YAPC::NA 2016</a>.</div>
                 </div>

               <h2>Need Help?</h2>
               <p>Rex is a pure open source project, you can find community support in the following places:</p>
               <ul>
                  <li>IRC: <a href="irc://irc.freenode.net/rex">#rex on irc.freenode.net</a></li>
                  <li>Groups: <a href="https://groups.google.com/group/rex-users/">Rex Users</a></li>
                  <li>Serverfault: <a href="http://serverfault.com/questions/tagged/rex">Tag with <i>rex</i></a></li>
                  <li>Issues: <a href="https://github.com/RexOps/Rex/issues">on GitHub</a></li>
                  <li>Feature: you miss a <a href="/feature.html">feature</a>?</li>
               </ul>
               <p><a href="/support/index.html">Professional support</a> is also available.</p>
            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
              




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/the_rex_dsl/index.html">The rex dsl</a>
» <a href="/docs/rex_book/the_rex_dsl/using_environments.html">Using Environments</a>
</p>

              
              <h1>Using Environments</h1>
              <p>With environments it is easy to group your servers depending on the maturity of your configuration or your code.</p>

<p>You can create environments for dev, staging and production machines. There is no limit for environments, so you can create as much as you need.</p>

<p>The classic way is to have 3 environments. The development environment for integration tests, mostly with fewest machines. The staging environment, mostly with the same resource layers as production. And the production environment.</p>

<p><img height="464" src="/public/images/skin/rexify.org/book_env.png" width="619"></p>

<h2 id="creatingenvironments">Creating Environments</h2>

<p>Creating environments is as easy as creating groups. To create environments you can use the environment function. Inside an environment you can place everything that is specific for this environment (like authentication, server groups, tasks, ...).</p>

<pre><code># Rexfile
use Rex -feature =&gt; [&#39;1.0&#39;];

environment test =&gt; sub {
  user &quot;root&quot;;
  password &quot;b0x&quot;;

  group frontend   =&gt; &quot;fe01.test&quot;;
  group middleware =&gt; &quot;mw01.test&quot;;
  group dbwrite    =&gt; &quot;dbm01.test&quot;;
};

environment stage =&gt; sub {
  user &quot;root&quot;;
  password &quot;b0xst4g3&quot;;

  group loadbalancer =&gt; &quot;lb01.stage&quot;;
  group frontend     =&gt; &quot;fe01.stage&quot;;
  group middleware   =&gt; &quot;mw01.stage&quot;;
  group dbread       =&gt; &quot;dbs01.stage&quot;;
  group dbwrite      =&gt; &quot;dbm01.stage&quot;;
};

environment live =&gt; sub {
  user &quot;admin&quot;;
  password &quot;b0xl1v3&quot;;
  sudo_password &quot;b0xl1v3&quot;;
  sudo TRUE;

  group loadbalancer =&gt; &quot;lb[01..02].live&quot;;
  group frontend     =&gt; &quot;fe[01..03].live&quot;;
  group middleware   =&gt; &quot;mw[01..02].live&quot;;
  group dbread       =&gt; &quot;dbs[01..02].live&quot;;
  group dbwrite      =&gt; &quot;dbm01.live&quot;;
};
</code></pre>

<h2 id="runningtasks">Running tasks</h2>

<p>To run the task inside a special environment you have to use the cli option -E</p>

<pre><code>$ rex -E stage $task
</code></pre>

<p>If you need to configure systems depending on the environment you can get the current environment inside a task with the environment function.</p>

<pre><code># Rexfile
task &quot;prepare&quot;, group =&gt; &quot;frontend&quot;, make {
  # configure ntp.conf depending on the environment
  my $ntp_server = case environment, {
                     test    =&gt; [&quot;ntp01.test&quot;],
                     stage   =&gt; [&quot;ntp01.stage&quot;],
                     live    =&gt; [&quot;ntp01.live&quot;, &quot;ntp02.live&quot;],
                     default =&gt; [&quot;ntp01.test&quot;],
                   };

  file &quot;/etc/ntp.conf&quot;,
    content   =&gt; template(&quot;templates/etc/ntp.conf&quot;, ntp_server =&gt; $ntp_server),
    owner     =&gt; &quot;root&quot;,
    group     =&gt; &quot;root&quot;,
    mode      =&gt; 644,
    on_change =&gt; make { service ntpd =&gt; &quot;restart&quot;; };
};
</code></pre>

<h2 id="environmentsandthecmdb">Environments and the CMDB</h2>

<p>If you&#39;re using a CMDB to separate data from code you can also create YAML files for the different environments.</p>

<p>The lookup path for the default YAML CMDB is as follow:</p>

<ul>
<li>$server.yml</li>
<li>$environment/$server.yml</li>
<li>$environment/default.yml</li>
<li>default.yml</li>
</ul>

<h3 id="theyamlfiles">The YAML files</h3>

<pre><code># File: cmdb/default.yml
ntp_server:
  - ntp01.test

# File: cmdb/test/default.yml
ntp_server:
  - ntp01.test

# File: cmdb/stage/default.yml
ntp_server:
  - ntp01.stage

# File: cmdb/live/default.yml
ntp_server:
  - ntp01.live
  - ntp02.live
</code></pre>

<h3 id="therexfile">The Rexfile</h3>

<p>To use the CMDB you have to require and configure the Rex::CMDB module first.</p>

<pre><code># Rexfile
use Rex -feature =&gt; [&#39;1.0&#39;];
use Rex::CMDB;

set cmdb =&gt; {
  type =&gt; &quot;YAML&quot;,
  path =&gt; &quot;./cmdb&quot;,
};

task &quot;prepare&quot;, group =&gt; &quot;frontend&quot;, make {
  # configure ntp.conf depending on the environment
  my $ntp_server = get cmdb &quot;ntp_server&quot;;

  file &quot;/etc/ntp.conf&quot;,
    content   =&gt; template(&quot;templates/etc/ntp.conf&quot;, ntp_server =&gt; $ntp_server),
    owner     =&gt; &quot;root&quot;,
    group     =&gt; &quot;root&quot;,
    mode      =&gt; 644,
    on_change =&gt; make { service ntpd =&gt; &quot;restart&quot;; };
};
</code></pre>

<p>Now you can run the task with <code>rex -E test prepare</code>.</p>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <a href="https://groups.google.com/group/rex-users/">Google Group</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="http://www.freelists.org/list/rex-users">Mailinglist</a> / <a href="irc://irc.freenode.net/rex">irc.freenode.net #rex</a><span id="syntax_high" style="display: none;"> / <a href="#" id="link_syntax_high">Enable Syntax Highlighting</a></span>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

<script>
  hljs.tabReplace = '    ';
  hljs.initHighlightingOnLoad();
</script>


   </body>

</html>
