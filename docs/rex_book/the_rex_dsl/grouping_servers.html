<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Grouping servers</title>

      <meta content="Grouping servers" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://www.rexify.org/docs/rex_book/the_rex_dsl/grouping_servers.html" property="og:url">
      <meta content="https://www.rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2020-05-05</b><br>
                     <a href="/blog/2020/05/05/rex-1.10.0.html">Rex-1.10.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.10.0.html">Rex-1.10.0 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a> (<a href="https://metacpan.org/source/FERKI/Rex-1.10.0/ChangeLog">changelog</a>). Apart from documentation updates and bug fixes, it adds initial package glob support, and an <code>on_change</code> hook for the <code>mkdir</code> command.</p>

                   <p><b>2020-04-05</b><br>
                     <a href="/blog/2020/04/05/rex-1.9.0.html">Rex-1.9.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.9.0.html">Rex-1.9.0 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, and it adds a new feature flag to force writing UTF-8 encoded files, <a href="https://metacpan.org/pod/Rex::Config">documents configuration options</a>, and fixes bugs.</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/rex-1.8.2.html">Rex-1.8.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.8.2.html">Rex-1.8.2 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, fixing a bug related to task hooks.</p>

                   <p><b>2020-02-05</b><br>
                     <a href="/blog/2020/02/05/rex-1.8.1.html">Rex-1.8.1</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.8.1.html">Rex-1.8.1 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, improving release automation, packaging, and documentation.</p>

                   <p><b>2020-01-05</b><br>
                     <a href="/blog/2020/01/05/rex-1.8.0.html">Rex-1.8.0</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.8.0.html">Rex-1.8.0 release</a> is now available on <a href="https://metacpan.org/release/Rex">CPAN</a>, adding initial support to manage Void Linux systems.</p>


               <h2>Conferences</h2>
                 <div class="news_widget">
                    <div class="news_date">2016-06-21</div>
                    <div class="news_content"><a href="http://preaction.me/">Doug Bell (preaction)</a> from <a href="http://chicago.pm.org/">Chicago.pm</a> will give an <a href="http://www.yapcna.org/yn2016/talk/6549">Introduction to Rex</a> talk at <a href="http://www.yapcna.org/yn2016/">YAPC::NA 2016</a>.</div>
                 </div>

               <h2>Need Help?</h2>
               <p>Rex is a pure open source project, you can find community support in the following places:</p>
               <ul>
                  <li>IRC: <a href="irc://irc.freenode.net/rex">#rex on irc.freenode.net</a></li>
                  <li>Groups: <a href="https://groups.google.com/group/rex-users/">Rex Users</a></li>
                  <li>Serverfault: <a href="http://serverfault.com/questions/tagged/rex">Tag with <i>rex</i></a></li>
                  <li>Issues: <a href="https://github.com/RexOps/Rex/issues">on GitHub</a></li>
                  <li>Feature: you miss a <a href="/care/help__r__ex.html">feature</a>?</li>
               </ul>
               <p><a href="/support/index.html">Professional support</a> is also available.</p>
            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/the_rex_dsl/index.html">The rex dsl</a>
» <a href="/docs/rex_book/the_rex_dsl/grouping_servers.html">Grouping servers</a>
</p>

              
              <h1>Grouping servers</h1>
              <p>Rex offers you a powerful way to group your servers. The simplest way to use groups is to just define a group name and add all your desired servers to this group.</p>

<pre><code class="hljs">⁠group frontends =&gt; &quot;<span class="hljs-string">frontend01</span>&quot;, &quot;<span class="hljs-string">frontend02</span>&quot;, &quot;<span class="hljs-string">frontend03</span>&quot;;
⁠group backends  =&gt; &quot;<span class="hljs-string">backend01</span>&quot;,  &quot;<span class="hljs-string">backend02</span>&quot;;</code></pre>

<p>Rex offers also a simple notation to define server ranges, so that you don&#39;t need to type so much.</p>

<pre><code class="hljs">⁠group frontends =&gt; &quot;<span class="hljs-string">frontend[01..03]</span>&quot;;
⁠group backends  =&gt; &quot;<span class="hljs-string">backend[01..02]</span>&quot;;</code></pre>

<p>This notation will just expand to frontend01, frontend02 and frontend03 for the frontends group and to backend01 and backend02 for the backends group.</p>

<p>Custom parameters for servers are possible with a slightly enhanced syntax since version 0.47:</p>

<pre><code class="hljs">⁠group frontends =&gt; &quot;<span class="hljs-string">frontend01</span>&quot; =&gt; { user =&gt; &quot;<span class="hljs-string">bob</span>&quot; },
⁠  &quot;<span class="hljs-string">frontend02</span>&quot; =&gt; { user =&gt; &quot;<span class="hljs-string">alice</span>&quot; },
⁠  &quot;<span class="hljs-string">frontend03</span>&quot;;</code></pre>

<p>Because the Rexfile is a Perl script you can just use more advanced things like querying a database, ldap or your dns.</p>

<p>To add your groups to the tasks you have to use the group option within the task generation.</p>

<pre><code class="hljs">⁠task &quot;<span class="hljs-string">mytask</span>&quot;,
⁠  group =&gt; &quot;<span class="hljs-string">mygroup</span>&quot;,
⁠  <span class="hljs-keyword">sub </span>{
⁠    <span class="hljs-comment"># do something</span><span class="hljs-comment">
⁠</span>  };</code></pre>

<p>If you need to define multiple groups for a task, you can just use an array.</p>

<pre><code class="hljs">⁠task &quot;<span class="hljs-string">mytask</span>&quot;,
⁠  group =&gt; [ &quot;<span class="hljs-string">mygroup</span>&quot;, &quot;<span class="hljs-string">mygroup2</span>&quot; ],
⁠  <span class="hljs-keyword">sub </span>{
⁠    <span class="hljs-comment"># do something</span><span class="hljs-comment">
⁠</span>  };</code></pre>

<h2 id="usinganinifiletodefineservergroups">Using an INI file to define server groups</h2>

<p>Rex offers a simple way to query ini files for group creation. To use ini files you have to use the Rex::Group::Lookup::INI module.</p>

<pre><code class="hljs">⁠<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
⁠<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Group</span>::<span class="hljs-function">Lookup</span>::<span class="hljs-function">INI</span>;
⁠
⁠groups_file &quot;<span class="hljs-string">/path/to/your/file.ini</span>&quot;;</code></pre>

<p>Rex expects the following format inside your INI file.</p>

<pre><code>[frontends]
frontend01
frontend02
frontend03

[backends]
backend01
backend02
</code></pre>

<p>Rex also offers a little bit advanced functions for the ini file. You can define custom parameters for each server or include groups inside groups.</p>

<pre><code>[frontends]
frontend01
frontend02 user=root password=f00bar auth_type=pass maintenance=1
frontend03

[backends]
backend01
backend02

[all]
@frontends
@backends
</code></pre>

<p>These additional options (in this example maintenance can be queried with the option method from the connection object.</p>

<pre><code class="hljs">⁠task &quot;<span class="hljs-string">prepare</span>&quot;,
⁠  group =&gt; &quot;<span class="hljs-string">frontends</span>&quot;,
⁠  <span class="hljs-keyword">sub </span>{
⁠    <span class="hljs-keyword">if</span> ( connection-&gt;server-&gt;option(&quot;<span class="hljs-string">maintenance</span>&quot;) ) {
⁠        say &quot;<span class="hljs-string">This server is in maintenance mode, so i&#39;m going to stop all services</span>&quot;;
⁠        service [ &quot;<span class="hljs-string">apache2</span>&quot;, &quot;<span class="hljs-string">postfix</span>&quot; ] =&gt; &quot;<span class="hljs-string">stop</span>&quot;;
⁠    }
⁠  };</code></pre>

<h2 id="queringadatabasetodefineservergroups">Quering a database to define server groups</h2>

<p>If you want to get your server groups right out of an existing database you can use DBI to connect to your database server. In this example you will learn how to connect to a MySQL database and to get the hosts out of a table.</p>

<pre><code class="hljs">⁠<span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
⁠<span class="hljs-keyword">use</span> DBI;
⁠
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$username</span> = &quot;<span class="hljs-string">dbuser</span>&quot;;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$password</span> = &quot;<span class="hljs-string">dbpassword</span>&quot;;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$database</span> = &quot;<span class="hljs-string">hostdb</span>&quot;;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$hostname</span> = &quot;<span class="hljs-string">mysql.intern.lan</span>&quot;;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$port</span>     = <span class="hljs-number">3306</span>;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$dsn</span>      = &quot;<span class="hljs-string">DBI:mysql:database=</span><span class="hljs-type">$database</span><span class="hljs-string">;host=</span><span class="hljs-type">$hostname</span><span class="hljs-string">;port=</span><span class="hljs-type">$port</span>&quot;;
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$dbh</span>      = DBI-&gt;<span class="hljs-function">connect</span>( <span class="hljs-type">$username</span>, <span class="hljs-type">$password</span> );
⁠
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">$sth</span> = <span class="hljs-type">$dbh</span>-&gt;<span class="hljs-type">prepare</span>(&quot;<span class="hljs-string">SELECT * FROM hostlist WHERE enabled=1</span>&quot;);
⁠
⁠<span class="hljs-keyword">my</span> <span class="hljs-type">%server_group</span> = ();
⁠<span class="hljs-keyword">while</span> ( <span class="hljs-keyword">my</span> <span class="hljs-type">$row</span> = <span class="hljs-type">$sth</span>-&gt;<span class="hljs-type">fetchrow_hashref</span> ) {
⁠    <span class="hljs-keyword">my</span> <span class="hljs-type">$group_name</span>  = <span class="hljs-type">$row</span>-&gt;{server_group};
⁠    <span class="hljs-keyword">my</span> <span class="hljs-type">$server_name</span> = <span class="hljs-type">$row</span>-&gt;{server_name};
⁠    <span class="hljs-function">push</span> <span class="hljs-type">@</span>{ <span class="hljs-type">$server_group</span>{<span class="hljs-type">$group_name</span>} }, <span class="hljs-type">$server_name</span>;
⁠}
⁠
⁠<span class="hljs-function">map</span> { group <span class="hljs-variable">$_</span> =&gt; <span class="hljs-type">@</span>{ <span class="hljs-type">$server_group</span>{<span class="hljs-variable">$_</span>} }; } <span class="hljs-function">keys</span> <span class="hljs-type">%server_group</span>;</code></pre>

<p>This example expects the following column names:</p>

<ul>
<li>server_group</li>
<li>server_name</li>
</ul>

<h2 id="creatingcustomgroups">Creating custom groups</h2>

<p>If there is no built-in function that fits your needs for group creation, you can do it all by yourself. Because the Rexfile is just a plain perl script and the group command is just a perl function that expects the group name as first parameter, and uses all other parameters for the servers, you can create your own function.</p>

<pre><code class="hljs">⁠<span class="hljs-keyword">my</span> <span class="hljs-type">@list</span> = ( &quot;<span class="hljs-string">some</span>&quot;, &quot;<span class="hljs-string">list</span>&quot;, &quot;<span class="hljs-string">entries</span>&quot; );
⁠group mygroup  =&gt; <span class="hljs-function">grep</span> { /list/ } <span class="hljs-type">@list</span>;
⁠group myserver =&gt; <span class="hljs-function">map</span>  { &quot;<span class="hljs-string">s</span><span class="hljs-variable">$_</span><span class="hljs-string">.domain.com</span>&quot; } qw(1 3 7);</code></pre>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="http://preaction.me/statocles/">Statocles</a></p>
      <a href="https://groups.google.com/group/rex-users/">Google Group</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://github.com/RexOps/Rex">GitHub</a> / <a href="http://www.freelists.org/list/rex-users">Mailinglist</a> / <a href="irc://irc.freenode.net/rex">irc.freenode.net #rex</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a>
   </div>

   </body>

</html>
