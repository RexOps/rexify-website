<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Grouping servers</title>

      <meta content="Grouping servers" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://rexify.org/docs/rex_book/the_rex_dsl/grouping_servers.html" property="og:url">
      <meta content="https://rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2025-02-05</b><br>
                     <a href="/blog/2025/02/05/rex-1.16.0.html">Rex-1.16.0</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.16.0.html">Rex-1.16.0</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.16.0">available on
CPAN</a>.</p>

<p>It now requires at least perl-5.14.4 to install, contains new features for
running commands on Windows, and fixes bugs around git repository branch
operations.</p>

                   <p><b>2024-11-05</b><br>
                     <a href="/blog/2024/11/05/rex-1.15.0.html">Rex-1.15.0</a></p><p>
                   </p><p></p><p><a href="https://github.com/RexOps/Rex/commit/cabbc6a8aa9eb2c0d9d3fc2439be51924edc3ff8">Happy 14th birthday, Rex!</a></p>

<p><a href="/docs/release_notes/1.15.0.html">Rex-1.15.0</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.15.0">available on CPAN</a>. It contains several bug fixes and a few new features.</p>

                   <p><b>2023-08-05</b><br>
                     <a href="/blog/2023/08/05/rex-1.14.3.html">Rex-1.14.3</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.14.3.html">Rex-1.14.3</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.3">available on CPAN</a>. It contains bug fixes for local package installation, command existence checks, and Git tests.</p>

                   <p><b>2023-05-05</b><br>
                     <a href="/blog/2023/05/05/rex-1.14.2.html">Rex-1.14.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.14.2.html">Rex-1.14.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.2">available on CPAN</a>. It contains bug fixes for running local commands on Windows, cloning git repositories, and test suite fixes for the upcoming perl-5.38.0 release.</p>

                   <p><b>2023-03-17</b><br>
                     <a href="/blog/2023/03/17/call-for-papers-tprc-2023.html">Call for papers TPRC 2023</a></p><p>
                   </p><p></p><p>Dean Hamstead from the The Perl and Raku Foundation Marketing Committee has sent an <a href="https://www.freelists.org/post/rex-users/Call-for-Papers-Talks-TPRC-2023">invitation to present about Rex at TPRC 2023</a>. I’m posting it here to increase visibility.</p>


               <h2>Events</h2>
                   <p><b>2021-03-08</b><br>
                     <a href="/blog/2021/03/04/learn_automation_using_rex.html">Learning automation using Rex</a></p><p>
                   </p><p></p><p>Ferenc Erki (FErki) will be the guest of <a href="https://www.linkedin.com/in/szabgab/">Gábor Szabó</a> on the next Code Maven live stream to learn about automation using Rex. Register for the free event via <a href="https://code-maven.com/automation-with-rex">Code Maven</a> or <a href="https://www.meetup.com/Code-Mavens/events/276730377/">Meetup</a>, and join the discussion!</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/unexpected_use_cases_with_rex.html">Unexpected use cases with Rex</a></p><p>
                   </p><p></p><p><a href="https://act.yapc.eu/gpw2020/talk/7699">Unexpected use cases with Rex</a> at the <a href="https://act.yapc.eu/gpw2020/index.html">22nd German Perl/Raku Workshop 2020</a> in Erlangen by Ferenc Erki (FErki).</p>

                   <p><b>2019-11-09</b><br>
                     <a href="/blog/2019/11/09/rex_and_friends_2019.html">Rex &amp; Friends</a></p><p>
                   </p><p></p><p><a href="https://friends.barcelona.pm/2019/#/talks/rex-and-friends">Rex &amp; Friends</a> talk at the <a href="https://friends.barcelona.pm">Barcelona Perl &amp; Friends 2019</a> by Ferenc Erki (FErki).</p>


            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/the_rex_dsl/index.html">The rex dsl</a>
» <a href="/docs/rex_book/the_rex_dsl/grouping_servers.html">Grouping servers</a>
</p>

              
              <h1>Grouping servers</h1>
              <p>Rex offers you a powerful way to group your servers. The simplest way to use groups is to just define a group name and add all your desired servers to this group.</p>

<pre><code class="hljs">group frontends =&gt; &quot;<span class="hljs-string">frontend01</span>&quot;, &quot;<span class="hljs-string">frontend02</span>&quot;, &quot;<span class="hljs-string">frontend03</span>&quot;;
group backends =&gt; &quot;<span class="hljs-string">backend01</span>&quot;, &quot;<span class="hljs-string">backend02</span>&quot;;</code></pre>

<p>Rex offers also a simple notation to define server ranges, so that you don&#39;t need to type so much.</p>

<pre><code class="hljs">group frontends =&gt; &quot;<span class="hljs-string">frontend[01..03]</span>&quot;;
group backends  =&gt; &quot;<span class="hljs-string">backend[01..02]</span>&quot;;</code></pre>

<p>This notation will just expand to frontend01, frontend02 and frontend03 for the frontends group and to backend01 and backend02 for the backends group.</p>

<p>Custom parameters for servers are possible with a slightly enhanced syntax since version 0.47:</p>

<pre><code class="hljs">group frontends =&gt; &quot;<span class="hljs-string">frontend01</span>&quot; =&gt; { user =&gt; &quot;<span class="hljs-string">bob</span>&quot; },
  &quot;<span class="hljs-string">frontend02</span>&quot; =&gt; { user =&gt; &quot;<span class="hljs-string">alice</span>&quot; },
  &quot;<span class="hljs-string">frontend03</span>&quot;;</code></pre>

<p>Because the Rexfile is a Perl script you can just use more advanced things like querying a database, ldap or your dns.</p>

<p>To add your groups to the tasks you have to use the group option within the task generation.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">mytask</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">mygroup</span>&quot;,
  <span class="hljs-keyword">sub </span>{
    <span class="hljs-comment"># do something</span><span class="hljs-comment">
</span>  };</code></pre>

<p>If you need to define multiple groups for a task, you can just use an array.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">mytask</span>&quot;,
  group =&gt; [ &quot;<span class="hljs-string">mygroup</span>&quot;, &quot;<span class="hljs-string">mygroup2</span>&quot; ],
  <span class="hljs-keyword">sub </span>{
    <span class="hljs-comment"># do something</span><span class="hljs-comment">
</span>  };</code></pre>

<h2 id="usinganinifiletodefineservergroups">Using an INI file to define server groups</h2>

<p>Rex offers a simple way to query ini files for group creation. To use ini files you have to use the Rex::Group::Lookup::INI module.</p>

<pre><code class="hljs"><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::Group</span>::<span class="hljs-function">Lookup</span>::<span class="hljs-function">INI</span>;

groups_file &quot;<span class="hljs-string">/path/to/your/file.ini</span>&quot;;</code></pre>

<p>Rex expects the following format inside your INI file.</p>

<pre><code>[frontends]
frontend01
frontend02
frontend03

[backends]
backend01
backend02
</code></pre>

<p>Rex also offers a little bit advanced functions for the ini file. You can define custom parameters for each server or include groups inside groups.</p>

<pre><code>[frontends]
frontend01
frontend02 user=root password=f00bar auth_type=pass maintenance=1
frontend03

[backends]
backend01
backend02

[all]
@frontends
@backends
</code></pre>

<p>These additional options (in this example maintenance can be queried with the option method from the connection object.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">prepare</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">frontends</span>&quot;,
  <span class="hljs-keyword">sub </span>{
    <span class="hljs-keyword">if</span> ( connection-&gt;server-&gt;option(&quot;<span class="hljs-string">maintenance</span>&quot;) ) {
        say &quot;<span class="hljs-string">This server is in maintenance mode, so i&#39;m going to stop all services</span>&quot;;
        service [ &quot;<span class="hljs-string">apache2</span>&quot;, &quot;<span class="hljs-string">postfix</span>&quot; ] =&gt; &quot;<span class="hljs-string">stop</span>&quot;;
    }
  };</code></pre>

<h2 id="queringadatabasetodefineservergroups">Quering a database to define server groups</h2>

<p>If you want to get your server groups right out of an existing database you can use DBI to connect to your database server. In this example you will learn how to connect to a MySQL database and to get the hosts out of a table.</p>

<pre><code class="hljs"><span class="hljs-keyword">use</span> Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];
<span class="hljs-keyword">use</span> DBI;

<span class="hljs-keyword">my</span> <span class="hljs-type">$username</span> = &quot;<span class="hljs-string">dbuser</span>&quot;;
<span class="hljs-keyword">my</span> <span class="hljs-type">$password</span> = &quot;<span class="hljs-string">dbpassword</span>&quot;;
<span class="hljs-keyword">my</span> <span class="hljs-type">$database</span> = &quot;<span class="hljs-string">hostdb</span>&quot;;
<span class="hljs-keyword">my</span> <span class="hljs-type">$hostname</span> = &quot;<span class="hljs-string">mysql.intern.lan</span>&quot;;
<span class="hljs-keyword">my</span> <span class="hljs-type">$port</span>     = <span class="hljs-number">3306</span>;
<span class="hljs-keyword">my</span> <span class="hljs-type">$dsn</span>      = &quot;<span class="hljs-string">DBI:mysql:database=</span><span class="hljs-type">$database</span><span class="hljs-string">;host=</span><span class="hljs-type">$hostname</span><span class="hljs-string">;port=</span><span class="hljs-type">$port</span>&quot;;
<span class="hljs-keyword">my</span> <span class="hljs-type">$dbh</span>      = DBI-&gt;<span class="hljs-function">connect</span>( <span class="hljs-type">$username</span>, <span class="hljs-type">$password</span> );

<span class="hljs-keyword">my</span> <span class="hljs-type">$sth</span> = <span class="hljs-type">$dbh</span>-&gt;<span class="hljs-type">prepare</span>(&quot;<span class="hljs-string">SELECT * FROM hostlist WHERE enabled=1</span>&quot;);

<span class="hljs-keyword">my</span> <span class="hljs-type">%server_group</span> = ();
<span class="hljs-keyword">while</span> ( <span class="hljs-keyword">my</span> <span class="hljs-type">$row</span> = <span class="hljs-type">$sth</span>-&gt;<span class="hljs-type">fetchrow_hashref</span> ) {
    <span class="hljs-keyword">my</span> <span class="hljs-type">$group_name</span>  = <span class="hljs-type">$row</span>-&gt;{server_group};
    <span class="hljs-keyword">my</span> <span class="hljs-type">$server_name</span> = <span class="hljs-type">$row</span>-&gt;{server_name};
    <span class="hljs-function">push</span> <span class="hljs-type">@</span>{ <span class="hljs-type">$server_group</span>{<span class="hljs-type">$group_name</span>} }, <span class="hljs-type">$server_name</span>;
}

<span class="hljs-function">map</span> { group <span class="hljs-variable">$_</span> =&gt; <span class="hljs-type">@</span>{ <span class="hljs-type">$server_group</span>{<span class="hljs-variable">$_</span>} }; } <span class="hljs-function">keys</span> <span class="hljs-type">%server_group</span>;</code></pre>

<p>This example expects the following column names:</p>

<ul>
<li>server_group</li>
<li>server_name</li>
</ul>

<h2 id="creatingcustomgroups">Creating custom groups</h2>

<p>If there is no built-in function that fits your needs for group creation, you can do it all by yourself. Because the Rexfile is just a plain perl script and the group command is just a perl function that expects the group name as first parameter, and uses all other parameters for the servers, you can create your own function.</p>

<pre><code class="hljs"><span class="hljs-keyword">my</span> <span class="hljs-type">@list</span> = ( &quot;<span class="hljs-string">some</span>&quot;, &quot;<span class="hljs-string">list</span>&quot;, &quot;<span class="hljs-string">entries</span>&quot; );
group mygroup  =&gt; <span class="hljs-function">grep</span> { /list/ } <span class="hljs-type">@list</span>;
group myserver =&gt; <span class="hljs-function">map</span>  { &quot;<span class="hljs-string">s</span><span class="hljs-variable">$_</span><span class="hljs-string">.domain.com</span>&quot; } qw(1 3 7);</code></pre>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="https://www.perl.org/">Perl</a> and built with <a href="http://preaction.me/statocles/">Statocles</a></p>
      <p>GitHub <a href="https://github.com/RexOps/Rex">repository</a> and <a href="https://github.com/RexOps/Rex/discussions">discussions</a> / Chat on <a href="https://matrix.to/#/#rexops:matrix.org">Matrix</a> and <a href="https://webchat.oftc.net/?channels=rexops">IRC</a> / Mailing list on <a href="https://groups.google.com/group/rex-users/">Google Groups</a> (retired: <a href="http://www.freelists.org/list/rex-users">rex-users@freelists</a>)</p>
      <p><a href="https://metacpan.org/dist/Rex">MetaCPAN</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://stackshare.io/rex">StackShare</a> / <a href="http://serverfault.com/questions/tagged/rex">Server Fault</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a></p>
   </div>

   </body>

</html>
