<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html prefix="og: http://ogp.me/ns#" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta content="text/html; charset=utf-8" http-equiv="content-type">

      <title>Deploying OpenLDAP and SSSD</title>

      <meta content="Deploying OpenLDAP and SSSD" property="og:title">
      <meta content="website" property="og:type">
      <meta content="https://rexify.org/docs/rex_book/managing_datacenters_and_the_cloud/deploying_openldap_and_sssd.html" property="og:url">
      <meta content="https://rexify.org/public/images/skin/rexify.org/open_graph.png" property="og:image">

      <meta content="width=1024, initial-scale=0.5" name="viewport">
      <link href="/public/images/skin/rexify.org/favicon.png" rel="shortcut icon">
      <link href="/public/css/skin/rexify.org/hs/tomorrow.css" rel="stylesheet">
      <link charset="utf-8" href="/public/css/skin/rexify.org/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
      <link charset="utf-8" href="/public/css/skin/rexify.org/default.css" media="screen" rel="stylesheet" type="text/css">
      <meta content="" name="description">
      <meta content="" name="keywords">

   </head>
   <body>

      <div id="page">

         <div class="top_div" id="top-div">
            <h1>(R)?ex <small>the friendly automation framework</small></h1>
            <div id="nav-div">
               
<div class="nav_links">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/get/index.html">Get Rex</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/care/index.html">Care</a>
      <ul class="dropdown_menu dropdown_care">
          <li><a href="/care/help__r__ex.html">Help (R)?ex</a></li>
          <li><a href="/care/help_people_in_need.html">Help people</a></li>
      </ul>
    </li>
    <li><a href="/support/index.html">Support</a></li>
    <li>
      <b class="arrow_box"></b>
      <a class="dropdown_link" href="/docs/index.html">Docs</a>
      <ul class="dropdown_menu dropdown_docs">
          <li><a href="/docs/faq/index.html">FAQ</a></li>
          <li><a href="/docs/guides/index.html">Guides</a></li>
          <li><a href="/docs/rex_book/index.html">Rex Book (work in progress)</a></li>
          <li><a href="/docs/release_notes/index.html">Release notes</a></li>
            <li class="divider"></li>
          <li><a href="https://metacpan.org/release/Rex">API</a></li>
      </ul>
    </li>
  </ul>
</div>

            </div>
            </div>
         </div>

         <div id="widgets_container">
            <div id="widgets">
               <h2>News</h2>
                   <p><b>2024-11-05</b><br>
                     <a href="/blog/2024/11/05/rex-1.15.0.html">Rex-1.15.0</a></p><p>
                   </p><p></p><p><a href="https://github.com/RexOps/Rex/commit/cabbc6a8aa9eb2c0d9d3fc2439be51924edc3ff8">Happy 14th birthday, Rex!</a></p>

<p><a href="/docs/release_notes/1.15.0.html">Rex-1.15.0</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.15.0">available on CPAN</a>. It contains bug several bug fixes and a few new features.</p>

                   <p><b>2023-08-05</b><br>
                     <a href="/blog/2023/08/05/rex-1.14.3.html">Rex-1.14.3</a></p><p>
                   </p><p></p><p><a href="/docs/release_notes/1.14.3.html">Rex-1.14.3</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.3">available on CPAN</a>. It contains bug fixes for local package installation, command existence checks, and Git tests.</p>

                   <p><b>2023-05-05</b><br>
                     <a href="/blog/2023/05/05/rex-1.14.2.html">Rex-1.14.2</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.14.2.html">Rex-1.14.2 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.2">available on CPAN</a>. It contains bug fixes for running local commands on Windows, cloning git repositories, and test suite fixes for the upcoming perl-5.38.0 release.</p>

                   <p><b>2023-03-17</b><br>
                     <a href="/blog/2023/03/17/call-for-papers-tprc-2023.html">Call for papers TPRC 2023</a></p><p>
                   </p><p></p><p>Dean Hamstead from the The Perl and Raku Foundation Marketing Committee has sent an <a href="https://www.freelists.org/post/rex-users/Call-for-Papers-Talks-TPRC-2023">invitation to present about Rex at TPRC 2023</a>. I’m posting it here to increase visibility.</p>

                   <p><b>2023-03-05</b><br>
                     <a href="/blog/2023/03/05/rex-1.14.1.html">Rex-1.14.1</a></p><p>
                   </p><p></p><p>The <a href="/docs/release_notes/1.14.1.html">Rex-1.14.1 release</a> is now <a href="https://metacpan.org/release/FERKI/Rex-1.14.1">available on CPAN</a>. It contains bug fixes and documentation updates.</p>


               <h2>Events</h2>
                   <p><b>2021-03-08</b><br>
                     <a href="/blog/2021/03/04/learn_automation_using_rex.html">Learning automation using Rex</a></p><p>
                   </p><p></p><p>Ferenc Erki (FErki) will be the guest of <a href="https://www.linkedin.com/in/szabgab/">Gábor Szabó</a> on the next Code Maven live stream to learn about automation using Rex. Register for the free event via <a href="https://code-maven.com/automation-with-rex">Code Maven</a> or <a href="https://www.meetup.com/Code-Mavens/events/276730377/">Meetup</a>, and join the discussion!</p>

                   <p><b>2020-03-05</b><br>
                     <a href="/blog/2020/03/05/unexpected_use_cases_with_rex.html">Unexpected use cases with Rex</a></p><p>
                   </p><p></p><p><a href="https://act.yapc.eu/gpw2020/talk/7699">Unexpected use cases with Rex</a> at the <a href="https://act.yapc.eu/gpw2020/index.html">22nd German Perl/Raku Workshop 2020</a> in Erlangen by Ferenc Erki (FErki).</p>

                   <p><b>2019-11-09</b><br>
                     <a href="/blog/2019/11/09/rex_and_friends_2019.html">Rex &amp; Friends</a></p><p>
                   </p><p></p><p><a href="https://friends.barcelona.pm/2019/#/talks/rex-and-friends">Rex &amp; Friends</a> talk at the <a href="https://friends.barcelona.pm">Barcelona Perl &amp; Friends 2019</a> by Ferenc Erki (FErki).</p>


            </div>
         </div> <!-- widgets -->

         <div id="content_container">
            <div id="content">
                




<p>
» <a href="/index.html">Home</a>
» <a href="/docs/index.html">Docs</a>
» <a href="/docs/rex_book/index.html">Rex book</a>
» <a href="/docs/rex_book/managing_datacenters_and_the_cloud/index.html">Managing datacenters and the cloud</a>
» <a href="/docs/rex_book/managing_datacenters_and_the_cloud/deploying_openldap_and_sssd.html">Deploying OpenLDAP and SSSD</a>
</p>

              
              <h1>Deploying OpenLDAP and SSSD</h1>
              <p>OpenLDAP (<a href="http://www.openldap.org/">http://www.openldap.org/</a>) is an open source directory server widely used for account management. It is easy to setup and administrate. There are also some Webfrontends like <a href="http://phpldapadmin.sourceforge.net/">http://phpldapadmin.sourceforge.net/</a> and <a href="https://www.ldap-account-manager.org/lamcms/">https://www.ldap-account-manager.org/lamcms/</a>.</p>

<p>SSSD (<a href="https://fedorahosted.org/sssd/">https://fedorahosted.org/sssd/</a>) is the acronym for System Security Services Daemon. With its help it is possible to to authenticate your linux users against an OpenLDAP directory server with some nifty additions like offline support.</p>

<h2 id="preparation">Preparation</h2>

<p>This guide is written for CentOS 6. So if you&#39;re using another distribution you might need to change some things.</p>

<h3 id="projectsetup">Project Setup</h3>

<p>To initialize your project you can use the rexify command to download the code and all dependencies.</p>

<pre><code>rexify --init=https://github.com/RexOps/ldap-sssd-ssh-rex.git
</code></pre>

<p>This command will download the code and all dependencies into the folder ldap-sssd-ssh-rex.</p>

<h2 id="exploringtherexfile">Exploring the Rexfile</h2>

<p>Now i will guide you through the Rexfile so that you can modify it to your needs and setup your OpenLDAP/SSSD infrastructure.</p>

<h3 id="loadingallrequiredlibraries">Loading all required libraries</h3>

<p>If you open the Rexfile you&#39;ll see at the top some use commands.</p>

<pre><code class="hljs">use Rex -feature =&gt; [&#39;<span class="hljs-string">1.0</span>&#39;];</code></pre>

<p>This loads the base functions of Rex 1.0, so that you can use them inside the Rexfile.</p>

<pre><code class="hljs"><span class="hljs-keyword">use</span> <span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>;
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">Commands</span>;
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">UserManagement</span>::<span class="hljs-function">Commands</span>;
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">UserManagement</span>::<span class="hljs-function">Client</span>;
<span class="hljs-keyword">use</span> <span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">UserManagement</span>::<span class="hljs-function">Server</span>;</code></pre>

<p>This loads all the LDAP functions we&#39;re going to use to setup the OpenLDAP server and the authentication on the clients.</p>

<h3 id="authentication">Authentication</h3>

<p>You also need to tell Rex how it can login to your servers. Rex supports password and key authentication.</p>

<pre><code class="hljs">user &quot;<span class="hljs-string">root</span>&quot;;
password &quot;<span class="hljs-string">box</span>&quot;;</code></pre>

<p>Here Rex is taught to login as user root with the password box. If you want to use key based authentication you can use something like this.</p>

<pre><code class="hljs">user &quot;<span class="hljs-string">root</span>&quot;;
private_key &quot;<span class="hljs-string">/home/your-user/.ssh/id_rsa</span>&quot;;
public_key &quot;<span class="hljs-string">/home/your-user/.ssh/id_rsa.pub</span>&quot;;</code></pre>

<h3 id="groupyourserver">Group your server</h3>

<p>Rex also needs to know on which server it should connect. So you can define server groups.</p>

<pre><code class="hljs">group server =&gt; &quot;<span class="hljs-string">auth01</span>&quot;;
group client =&gt; &quot;<span class="hljs-string">auth01</span>&quot;, &quot;<span class="hljs-string">fe[01..10]</span>&quot;;</code></pre>

<h3 id="setupopenldap">Setup OpenLDAP</h3>

<p>To setup OpenLDAP it is important to follow one rule. Never ever try to manage the configuration files inside /etc/openldap/slapd.d with an editor or by writing to the files directly. Sooner or later this will get you into trouble. So always use ldapmodify/ldapadd command to change things inside this directory.</p>

<p>With Rex you can use ldap_entry resource to manage these entries.</p>

<p>The default installation of OpenLDAP is not able to manage SSH Keys inside it. But there is a schema we will add to it later so that this is possible, too.</p>

<p>If you consider to put your OpenLDAP installation to production i recommend you to read <a href="http://www.openldap.org/doc/admin24/replication.html">http://www.openldap.org/doc/admin24/replication.html</a> how to setup replication.</p>

<p>This tutorial also do not cover the access control management. Please read <a href="http://www.openldap.org/doc/admin24/access-control.html">http://www.openldap.org/doc/admin24/access-control.html</a> for more information on this topic.</p>

<p>In the Rexfile you&#39;ll find the task setup_server.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">setup_server</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">server</span>&quot;,
  make {
    <span class="hljs-comment"># we will add more code here in a bit</span><span class="hljs-comment">
</span>  };</code></pre>

<p>This task is configured to run on all servers registered in the group server.</p>

<pre><code class="hljs"><span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">setup</span> {
    ldap_admin_password         =&gt; &#39;<span class="hljs-string">admin</span>&#39;,
    ldap_base_dn                =&gt; &#39;<span class="hljs-string">dc=rexify,dc=org</span>&#39;,
    ldap_base_dn_admin_password =&gt; &#39;<span class="hljs-string">test</span>&#39;,
    ldap_configure_tls          =&gt; TRUE,
};

<span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">UserManagement</span>::<span class="hljs-function">Server</span>::<span class="hljs-function">add_ssh_public_key</span>;</code></pre>

<p>First it install OpenLDAP and create a root database for you. It also configures the admin password of your LDAP server.</p>

<ul>
<li><em>ldap_base_dn</em> is the name of the database Rex should create for you. Normaly you want to add your organizations domain. Something like dc=company,dc=tld.</li>
<li><em>ldap_base_db_admin_password</em> is the password for the admin account of your database. This will be cn=admin,dc=rexify,dc=org.</li>
<li><em>ldap_configure_tls</em> can be set to TRUE or FALSE. If you set it to true, you have to add the SSL cert-, key- and ca file into the folder files/openldap/certs, so that Rex can upload them to the LDAP server.</li>
</ul>

<p>The second function call <code>add_ssh_public_key</code> will add the SSH-key schema to the OpenLDAP server, so that it is possible to add the public ssh keys into OpenLDAP.</p>

<h3 id="populatingopenldap">Populating OpenLDAP</h3>

<p>Now you have a working OpenLDAP you need to populate it with some data.</p>

<p>First we need to create a default folder structure inside it, so you can manage your groups and users. For this you can use the ldap_entry resource. This resource ensures that the entry exists and has the options set that are defined.</p>

<pre><code class="hljs">ldap_entry &quot;<span class="hljs-string">ou=People,dc=rexify,dc=org</span>&quot;,
  ensure      =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  objectClass =&gt; [ &#39;<span class="hljs-string">top</span>&#39;, &#39;<span class="hljs-string">organizationalUnit</span>&#39; ],
  ou          =&gt; &#39;<span class="hljs-string">People</span>&#39;;

ldap_entry &quot;<span class="hljs-string">ou=Groups,dc=rexify,dc=org</span>&quot;,
  ensure      =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  objectClass =&gt; [ &#39;<span class="hljs-string">top</span>&#39;, &#39;<span class="hljs-string">organizationalUnit</span>&#39; ],
  ou          =&gt; &#39;<span class="hljs-string">Groups</span>&#39;;

ldap_entry &quot;<span class="hljs-string">ou=Services,dc=rexify,dc=org</span>&quot;,
  ensure      =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  objectClass =&gt; [ &#39;<span class="hljs-string">top</span>&#39;, &#39;<span class="hljs-string">organizationalUnit</span>&#39; ],
  ou          =&gt; &#39;<span class="hljs-string">Services</span>&#39;;</code></pre>

<p>This code creates 3 <em>folders</em> (the LDAP name for such a <em>folder</em> is <em>organizationalUnit</em>, hence the acronym ou). One for the user accounts <em>ou=People,dc=rexify,dc=org</em>, one for the groups <em>ou=Groups,dc=rexify,dc=org</em> and one for special service accounts <em>ou=Services,dc=rexify,dc=org</em>.</p>

<p>You can create you own structure this is just an example.</p>

<p>Then you need to create a service user for sssd. SSSD use this user to search the LDAP database to find the user that tries to login.</p>

<pre><code class="hljs">ldap_account &quot;<span class="hljs-string">sssd</span>&quot;,
  ensure        =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  dn            =&gt; &#39;<span class="hljs-string">ou=Services,dc=rexify,dc=org</span>&#39;,
  givenName     =&gt; &#39;<span class="hljs-string">SSSD</span>&#39;,
  sn            =&gt; &#39;<span class="hljs-string">Service User</span>&#39;,
  uidNumber     =&gt; &#39;<span class="hljs-string">4000</span>&#39;,
  gidNumber     =&gt; 0,
  loginShell    =&gt; &#39;<span class="hljs-string">/bin/false</span>&#39;,
  homeDirectory =&gt; &#39;<span class="hljs-string">/tmp</span>&#39;,
  userPassword  =&gt; &#39;<span class="hljs-string">abcdef</span>&#39;;</code></pre>

<p>Now lets create a sample group and user.</p>

<pre><code class="hljs">ldap_group &quot;<span class="hljs-string">ldapusers</span>&quot;,
  ensure    =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  dn        =&gt; &#39;<span class="hljs-string">ou=Groups,dc=rexify,dc=org</span>&#39;,
  gidNumber =&gt; <span class="hljs-number">3000</span>;

ldap_account &quot;<span class="hljs-string">sampleuser</span>&quot;,
  ensure        =&gt; &#39;<span class="hljs-string">present</span>&#39;,
  dn            =&gt; &#39;<span class="hljs-string">ou=People,dc=rexify,dc=org</span>&#39;,
  givenName     =&gt; &#39;<span class="hljs-string">SampleUser</span>&#39;,
  sn            =&gt; &#39;<span class="hljs-string">Surename</span>&#39;,
  uidNumber     =&gt; <span class="hljs-number">5000</span>,
  gidNumber     =&gt; <span class="hljs-number">3000</span>,
  homeDirectory =&gt; &#39;<span class="hljs-string">/home/sampleuser</span>&#39;,
  loginShell    =&gt; &#39;<span class="hljs-string">/bin/bash</span>&#39;,
  mail          =&gt; &#39;<span class="hljs-string">sample.user@gmail.com</span>&#39;,
  userPassword  =&gt; &#39;<span class="hljs-string">{CRYPT}vPYgtKD.j9iL2</span>&#39;,
  sshPublicKey  =&gt; &#39;<span class="hljs-string">ssh-rsa AAAAB3NzaC1y...</span>&#39;,
  groups        =&gt; [&#39;<span class="hljs-string">cn=ldapusers,ou=Groups,dc=rexify,dc=org</span>&#39;];</code></pre>

<p>This will create a group names ldapusers inside the organizational unit (ou) ou=Groups,dc=rexify,dc=org and a user sampleuser inside ou=People,dc=rexify,dc=org. You can create the crypted password string with the tool slapdpasswd. <br>
Setup SSSD</p>

<p>Now, after you have setup OpenLDAP it is time to setup SSSD. For this there is a task setup_client inside the Rexfile.</p>

<pre><code class="hljs">task &quot;<span class="hljs-string">setup_client</span>&quot;,
  group =&gt; &quot;<span class="hljs-string">client</span>&quot;,
  make {
    <span class="hljs-comment"># we will add more code here in a bit</span><span class="hljs-comment">
</span>  };</code></pre>

<p>This task is configured to run on all servers inside the group client.</p>

<pre><code class="hljs"><span class="hljs-function">Rex::LDAP</span>::<span class="hljs-function">OpenLDAP</span>::<span class="hljs-function">UserManagement</span>::<span class="hljs-function">Client</span>::<span class="hljs-function">setup</span> {
    ldap_base_dn       =&gt; &#39;<span class="hljs-string">dc=rexify,dc=org</span>&#39;,
    ldap_uri           =&gt; &#39;<span class="hljs-string">ldaps://10.211.55.168</span>&#39;,
    ldap_bind_dn       =&gt; &#39;<span class="hljs-string">cn=sssd,ou=Services,dc=rexify,dc=org</span>&#39;,
    ldap_bind_password =&gt; &#39;<span class="hljs-string">abcdef</span>&#39;,
    ldap_base_user_dn  =&gt; &#39;<span class="hljs-string">ou=People,dc=rexify,dc=org</span>&#39;,
    ldap_base_group_dn =&gt; &#39;<span class="hljs-string">ou=Groups,dc=rexify,dc=org</span>&#39;,
    configure_ssh_ldap =&gt; TRUE,
};</code></pre>

<ul>
<li>ldap_base_dn is the root of your LDAP database.</li>
<li>ldap_uri the URL to your OpenLDAP server. If you&#39;re not using SSL you can use ldap://servername.</li>
<li>ldap_bind_dn the service use SSSD should use to search for the user that wants to login.</li>
<li>ldap_bind_password the password for the service user.</li>
<li>ldap_base_user_dn the root of the user directory.</li>
<li>ldap_base_group_dn the root of the group directory.</li>
<li>configure_ssh_ldap wether to configure sshd to check the public key against OpenLDAP.</li>
</ul>

<h2 id="setupsshd">Setup SSHD</h2>

<p>Since a few versions SSHd supports the execution of an external executable on connection. This is done with the AuthorizedKeysCommand option. If you use the configure_ssh_ldap option on client setup it will upload a script that queries the LDAP server for the ssh key of the user that wants to login.</p>

<p>The configuration of this script can be done in the file /etc/ssh/pubkey.yaml. The Rex::LDAP::OpenLDAP::UserManagement::Client::setup task automatically creates the right configuration for you.</p>

<pre><code>host: &#39;dc=rexify,dc=org&#39;
bind_dn: &#39;cn=sssd,ou=Services,dc=rexify,dc=org&#39;
bind_pw: &#39;abcdef&#39;
base_dn: &#39;dc=rexify,dc=org&#39;
filter: (&amp;(uid={{LOGIN_NAME}})(objectClass=posixAccount))
#tls:
#        verify: optional
#        cafile: /etc/openldap/certs/cacert.pem
</code></pre>



            </div>
         </div> <!-- content -->

       <!-- page -->


   <div class="clearfix"></div>
   <div class="bottom_bar">
      <p>Proudly powered by <a href="https://www.perl.org/">Perl</a> and built with <a href="http://preaction.me/statocles/">Statocles</a></p>
      <p>GitHub <a href="https://github.com/RexOps/Rex">repository</a> and <a href="https://github.com/RexOps/Rex/discussions">discussions</a> / Chat on <a href="https://matrix.to/#/#rexops:matrix.org">Matrix</a> and <a href="https://webchat.oftc.net/?channels=rexops">IRC</a> / Mailing list on <a href="https://groups.google.com/group/rex-users/">Google Groups</a> (retired: <a href="http://www.freelists.org/list/rex-users">rex-users@freelists</a>)</p>
      <p><a href="https://metacpan.org/dist/Rex">MetaCPAN</a> / <a href="http://twitter.com/RexOps">Twitter</a> / <a href="https://stackshare.io/rex">StackShare</a> / <a href="http://serverfault.com/questions/tagged/rex">Server Fault</a>   -.ô.-   <a href="http://www.disclaimer.de/disclaimer.htm" target="_blank">Disclaimer</a></p>
   </div>

   </body>

</html>
