<p>With environments it is easy to group your servers depending on the maturity of your configuration or your code.</p>
<p>You can create environments for dev, staging and production machines. There is no limit for environments, so you can create as much as you need.</p>
<p>The classic way is to have 3 environments. The development environment for integration tests, mostly with fewest machines. The staging environment, mostly with the same resource layers as production. And the production environment.</p>
<p><img src="../../media/book/book_env.png" alt="" width="619" height="464" /></p>
<h2>Creating Environments</h2>
<p>Creating environments is as easy as creating groups. To create environments you can use the environment function. Inside an environment you can place everything that is specific for this environment (like authentication, server groups, tasks, ...).</p>
<pre><code class="perl"># Rexfile<br /></code><code class="perl">use Rex -feature =&gt; ['1.0'];<br /><br /></code><code class="perl">environment test =&gt; sub {<br /></code><code class="perl">&nbsp; user "root";<br /></code><code class="perl">&nbsp; password "b0x";<br /><br /></code><code class="perl">&nbsp; group frontend&nbsp;&nbsp; =&gt; "fe01.test";<br /></code><code class="perl">&nbsp; group middleware =&gt; "mw01.test";<br /></code><code class="perl">&nbsp; group dbwrite&nbsp;&nbsp;&nbsp; =&gt; "dbm01.test";<br /></code><code class="perl">};<br /><br /></code><code class="perl">environment stage =&gt; sub {<br /></code><code class="perl">&nbsp; user "root";<br /></code><code class="perl">&nbsp; password "b0xst4g3";<br /><br /></code><code class="perl">&nbsp; group loadbalancer =&gt; "lb01.stage";<br /></code><code class="perl">&nbsp; group frontend&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "fe01.stage";<br /></code><code class="perl">&nbsp; group middleware&nbsp;&nbsp; =&gt; "mw01.stage";<br /></code><code class="perl">&nbsp; group dbread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "dbs01.stage";<br /></code><code class="perl">&nbsp; group dbwrite&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "dbm01.stage";<br /></code><code class="perl">};<br /><br /></code><code class="perl">environment live =&gt; sub {<br /></code><code class="perl">&nbsp; user "admin";<br /></code><code class="perl">&nbsp; password "b0xl1v3";<br /></code><code class="perl">&nbsp; sudo_password "b0xl1v3";<br /></code><code class="perl">&nbsp; sudo TRUE;<br /><br /></code><code class="perl">&nbsp; group loadbalancer =&gt; "lb[01..02].live";<br /></code><code class="perl">&nbsp; group frontend&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "fe[01..03].live";<br /></code><code class="perl">&nbsp; group middleware&nbsp;&nbsp; =&gt; "mw[01..02].live";<br /></code><code class="perl">&nbsp; group dbread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "dbs[01..02].live";<br /></code><code class="perl">&nbsp; group dbwrite&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "dbm01.live";<br /></code><code class="perl">};</code></pre>
<h2>Running tasks</h2>
<p>To run the task inside a special environment you have to use the cli option -E</p>
<pre>$ rex -E stage $task</pre>
<p>If you need to configure systems depending on the environment you can get the current environment inside a task with the environment function.</p>
<pre><code class="perl"># Rexfile<br /></code><code class="perl">task "prepare", group =&gt; "frontend", make {<br /></code><code class="perl">&nbsp; # configure ntp.conf depending on the environment<br /></code><code class="perl">&nbsp; my $ntp_server = case environment, {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp; =&gt; ["ntp01.test"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stage&nbsp;&nbsp; =&gt; ["ntp01.stage"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; live&nbsp;&nbsp;&nbsp; =&gt; ["ntp01.live", "ntp02.live"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default =&gt; ["ntp01.test"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /><br /></code><code class="perl">&nbsp; file "/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; content&nbsp;&nbsp; =&gt; template("templates/etc/ntp.conf", ntp_server =&gt; $ntp_server),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; owner&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; group&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; 644,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; on_change =&gt; make { service ntpd =&gt; "restart"; };<br /></code><code class="perl">};</code></pre>
<h2>Environments and the CMDB</h2>
<p>If you're using a CMDB to separate data from code you can also create YAML files for the different environments.</p>
<p>The lookup path for the default YAML CMDB is as follow:</p>
<ul>
<li>$server.yml</li>
<li>$environment/$server.yml</li>
<li>$environment/default.yml</li>
<li>default.yml</li>
</ul>
<h3>The YAML files</h3>
<pre># File: cmdb/default.yml<br />ntp_server:<br />&nbsp; - ntp01.test</pre>
<pre># File: cmdb/test/default.yml<br />ntp_server:<br />&nbsp; - ntp01.test</pre>
<pre># File: cmdb/stage/default.yml<br />ntp_server:<br />&nbsp; - ntp01.stage</pre>
<pre># File: cmdb/live/default.yml<br />ntp_server:<br />&nbsp; - ntp01.live<br />&nbsp; - ntp02.live</pre>
<h3>The Rexfile</h3>
<p>To use the CMDB you have to require and configure the Rex::CMDB module first.</p>
<pre><code class="perl"># Rexfile<br /></code><code class="perl">use Rex -feature =&gt; ['1.0'];<br /></code><code class="perl">use Rex::CMDB;<br /><br /></code><code class="perl">set cmdb =&gt; {<br /></code><code class="perl">&nbsp; type =&gt; "YAML",<br /></code><code class="perl">&nbsp; path =&gt; "./cmdb",<br /></code><code class="perl">};<br /><br /></code><code class="perl">task "prepare", group =&gt; "frontend", make {<br /></code><code class="perl">&nbsp; # configure ntp.conf depending on the environment<br /></code><code class="perl">&nbsp; my $ntp_server = get cmdb "ntp_server";<br /><br /></code><code class="perl">&nbsp; file "/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; content&nbsp;&nbsp; =&gt; template("templates/etc/ntp.conf", ntp_server =&gt; $ntp_server),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; owner&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; group&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; 644,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; on_change =&gt; make { service ntpd =&gt; "restart"; };<br /></code><code class="perl">};</code></pre>
<p>Now you can run the task with <code>rex -E test prepare</code>.</p>