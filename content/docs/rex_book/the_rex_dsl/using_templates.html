<p>A template is a text file containing special variables or perl code inside it. So with this technique you can generate dynamic configuration files. For example if you want to configure apache only to listen on a special ethernet device (eth0 for example) templates are what you need.</p>
<p>The default template engine is a special Rex template engine. The syntax is a bit like php or erb. But you can use any template engine you want. Just browse cpan and find one you like.</p>
<p>For example:</p>
<pre>Hello &lt;%= $name %&gt;!</pre>
<p>If $name contains "World" this template would result in the string Hello World!. This is very usefull if you have to maintain a large set of nearly identical configuration files.</p>
<h2>Working with a template</h2>
<p>First you have to create it</p>
<pre>$ mkdir files<br />$ vim files/my.cnf.tpl</pre>
<pre>[mysqld]<br />datadir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = /var/lib/mysql<br />socket&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = /var/run/mysqld/mysqld.sock<br />user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = mysql<br /># Disabling symbolic-links is recommended to prevent assorted security risks<br />symbolic-links&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0<br />datadir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = /var/lib/mysql<br />tmpdir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = /tmp<br />skip-external-locking<br />max_allowed_packet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 64M<br />thread_stack&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 192K<br />max_connections&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = &lt;%= exists $conf-&gt;{"max_connections"} ? $conf-&gt;{"max_connections"} : "1000" %&gt;<br /><br />max_connect_errors&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 1000<br />table_cache&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = &lt;%= exists $conf-&gt;{"table_cache"} ? $conf-&gt;{"table_cache"} : "5000" %&gt;<br />table_open_cache&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = &lt;%= exists $conf-&gt;{"table_open_cache"} ? $conf-&gt;{"table_open_cache"} : "5000" %&gt;<br />thread_concurrency&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 10<br /><br />#<br /># ... and more ...<br />#</pre>
<p>Than you can reference on it from within your Rexfile.</p>
<pre><code class="perl">use Rex -feature =&gt; ['1.0'];<br /><br /></code><code class="perl">user "root";<br /></code><code class="perl">key_auth;<br /><br /></code><code class="perl">group databases=&gt; "mydb01", "mydb02";<br /><br /></code><code class="perl">task "prepare_databases", group =&gt; "databases", sub {<br /></code><code class="perl">&nbsp;&nbsp; file "/etc/my.cnf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; owner&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; group&nbsp;&nbsp; =&gt; "root",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode&nbsp;&nbsp;&nbsp; =&gt; "644",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content =&gt; template("files/my.cnf.tpl", conf =&gt; {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_connections =&gt; "500",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; table_cache&nbsp;&nbsp;&nbsp;&nbsp; =&gt; "2500",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br /></code><code class="perl">};</code></pre>
<h2>Inline Templates</h2>
<p>When you want to deliver a rexfile that includes the templates, you can use inline templates. To use this feature, you have to use the __DATA__ section of your rexfile. You can also define several templates in that section:</p>
<h3>Using a single inline template</h3>
<pre><code class="perl">use Rex -feature =&gt; ['1.0'];<br /><br /></code><code class="perl">task tempfiles =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; file '/tmp/test.txt' =&gt;<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content =&gt; template(<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '@test',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test =&gt; {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; author =&gt; 'reneeb',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target =&gt; 'rex',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chmod =&gt; 644,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; ;<br /></code><code class="perl">};<br /><br /></code><code class="perl">__DATA__<br /></code><code class="perl">@test<br /></code><code class="perl">This is a test written by &lt;%= $test-&gt;{author} %&gt;<br /></code><code class="perl">for a project called &lt;%= $test-&gt;{target} %&gt;<br /></code><code class="perl">@end</code></pre>
<p>The <code>__DATA__</code> section is the last section of the Rexfile. The first parameter of the template method call gets the name of the inline template. Note that names of inline templates begin with <code>@</code>.</p>
<p>Rex knows that it has to look up the template in the <code>__DATA__</code> section of the file where template was called. Within the section the template starts with its name (here: <code>@test</code>) and then follows the template text.</p>
<h3>Using multiple inline templates</h3>
<pre><code class="perl">use Rex -feature =&gt; ['1.0'];<br /></code><code class="perl">task tempfiles =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; file '/tmp/test.txt' =&gt;<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content =&gt; template(<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '@test',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test =&gt; {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; author =&gt; 'reneeb',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target =&gt; 'rex',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chmod =&gt; 644,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; ;<br /><br /></code><code class="perl">&nbsp;&nbsp;&nbsp; file '/tmp/rex.txt' =&gt;<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content =&gt; template(&gt;<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '@rex',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test =&gt; {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; author =&gt; 'krimdomu',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target =&gt; 'rex',<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chmod =&gt; 644,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp; ;<br /></code><code class="perl">};<br /><br /></code><code class="perl">__DATA__<br /></code><code class="perl">@test<br /></code><code class="perl">This is a test written by &lt;%= $test-&gt;{author} %&gt;<br /></code><code class="perl">for a project called &lt;%= $test-&gt;{target} %&gt;<br /></code><code class="perl">@end<br /><br /></code><code class="perl">@rex<br /></code><code class="perl">Contribution by &lt;%= $test-&gt;{author} %&gt;<br /></code><code class="perl">for a project called &lt;%= $test-&gt;{target} %&gt;<br /></code><code class="perl">@end</code></pre>
<p>Now we just look at the <code>__DATA__</code> section: You notice the token <code>@end</code>. This is used to separate the templates. At the end of each template (except for the last one) this token is needed. Otherwise Rex will use everything up to the first <code>@end</code> as the template which is most likely too much.</p>