<p>Uploading hardcoded configuration files to your servers often isn't enough. Sometimes you must add values dynamically inside a file. For example if you want to bind a service to a special network interface or to configure different database servers for your application for your different environments. This can be easily achieved with templates.</p>
<p>In this example you will learn how to build a ntp module that uploads custom ntp.conf files for your test-, pre-prod-, and production environment.</p>
<p>First, we create a new module. For this guide you need at least Rex 0.41 (because of the --create-module command and the case keyword.) Execute the following command in the same directory where your Rexfile lives.</p>
<pre>rexify Service::NTP --create-module</pre>
<p>This will create some new directories and files in your lib directory.</p>
<pre>.<br />├── Rexfile<br />└── lib<br />&nbsp;&nbsp;&nbsp; └── Service<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── NTP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── __module__.pm<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── meta.yml</pre>
<p>The meta.yml file can be ignored. This file is only important if you want to share your module on the Rex modules directory.</p>
<p>The important file is __module__.pm. Open this file in an editor.<br /><br />This file is a normal Perl module. The only special thing is the filename, but don't think too much for it at first.</p>
<pre><code class="perl">package Service::NTP;<br /></code><code class="perl">use Rex -feature =&gt; ['1.3'];<br /></code><code class="perl"><br />task prepare =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp; my $service_name = case operating_system, {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Debian&nbsp; =&gt; "ntp",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default =&gt; "ntpd",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /></code><code class="perl">&nbsp;&nbsp; pkg "ntp",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "present";<br /><br /></code><code class="perl">&nbsp;&nbsp; file "/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp; =&gt; "files/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on_change =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service $service_name =&gt; "restart";<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /><br /></code><code class="perl">&nbsp;&nbsp; service $service_name,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "started";<br /></code><code class="perl">};<br /><br /></code>1;</pre>
<p>First the module checks if the OS is a debian (or ubuntu) and set the service name to "ntp" otherwise to "ntpd". After that it installs the "ntp" package and uploads the configuration file. Notice the on_change hook here. This will restart the ntp service if the file changes. At last Rex verifies that the service will start on system boot.<br /><br />Now it is time to create a basic ntp.conf file. Create the directory lib/Service/NTP/files/etc and place the ntp.conf file in there.</p>
<pre># /etc/ntp.conf, managed by Rex<br /><br />driftfile /var/run/ntp.drift<br /><br />statistics loopstats peerstats clockstats<br />filegen loopstats file loopstats type day enable<br />filegen peerstats file peerstats type day enable<br />filegen clockstats file clockstats type day enable<br /><br />server ntp01.company.tld<br />server ntp02.company.tld</pre>
<p>If you now want to distribute different ntp.conf files per environment you can add multiple ntp.conf files to that directory. Rex will than decide with the help of the -E $env cli parameter which file to use. Rex first try to find a file named ntp.conf.$environment and if that file does not exist it fallback to ntp.conf.</p>
<pre>.<br />├── Rexfile<br />└── lib<br />&nbsp;&nbsp;&nbsp; └── Service<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── NTP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── __module__.pm<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── files<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── etc<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── ntp.conf<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── ntp.conf.preprod<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── ntp.conf.prod<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── ntp.conf.test<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── meta.yml</pre>
<p>But if you want to change a parameter in your ntp.conf file you have to edit 4 files. This is not realy cool. To prevent that you can use templates.</p>
<pre><code class="perl">package Service::NTP;<br /></code><code class="perl">use Rex -feature =&gt; ['1.0'];<br /><br /></code><code class="perl">task prepare =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp; my $service_name = case operating_system, {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Debian&nbsp; =&gt; "ntp",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default =&gt; "ntpd",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /><br /></code><code class="perl">&nbsp;&nbsp; my $ntp_server&nbsp;&nbsp; = case environment, {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prod&nbsp;&nbsp;&nbsp; =&gt; ["ntp01.company.tld", "ntp02.company.tld"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preprod =&gt; ["ntp01.preprod.company.tld"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp; =&gt; ["ntp01.test.company.tld"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default =&gt; ["ntp01.company.tld"],<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /><br /></code><code class="perl">&nbsp;&nbsp; pkg "ntp",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "present";<br /><br /></code><code class="perl">&nbsp;&nbsp; file "/etc/ntp.conf",<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content&nbsp;&nbsp; =&gt; template("files/etc/ntp.conf", ntp_servers =&gt; $ntp_server),<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on_change =&gt; sub {<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service $service_name =&gt; "restart";<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br /><br /></code><code class="perl">&nbsp;&nbsp; service $service_name,<br /></code><code class="perl">&nbsp;&nbsp;&nbsp;&nbsp; ensure =&gt; "started";<br /></code><code class="perl">};<br /><br /></code><code class="perl">1;</code></pre>
<p>Now we can create our template. The default template of Rex looks similar to other templating engines. But you can also use other template engines like Template::Toolkit.</p>
<pre># /etc/ntp.conf, managed by Rex<br /><br />driftfile /var/run/ntp.drift<br /><br />statistics loopstats peerstats clockstats<br />filegen loopstats file loopstats type day enable<br />filegen peerstats file peerstats type day enable<br />filegen clockstats file clockstats type day enable<br /><br />&lt;% for my $server (@{ $ntp_servers }) { %&gt;<br />server &lt;%= $server %&gt;<br />&lt;% } %&gt;</pre>
<h2>Predefined Variables</h2>
<p>There are also some predefined variables you can use in your templates. For example the ip address of a network device if you want to bind a service on a specific ip. You can dump all predefined variable of a system with the following code.</p>
<pre><code class="perl">task "get_infos", "server01", sub {<br /></code><code class="perl">&nbsp;&nbsp; dump_system_information;<br /></code><code class="perl">};</code></pre>
<p>For example this is the output of a CentOS VM</p>
<pre>$kernelversion = '#1 SMP Tue May 15 22:09:39 BST 2012'<br />$memory_cached = '357'<br />$memory_total = '498'<br />$kernelrelease = '2.6.32-220.17.1.el6.i686'<br />$Kernel = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kernelversion =&gt; '#1 SMP Tue May 15 22:09:39 BST 2012'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; architecture =&gt; 'i686'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kernel =&gt; 'Linux'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kernelrelease =&gt; '2.6.32-220.17.1.el6.i686'<br />&nbsp;&nbsp; }<br />$hostname = 'c6test0232'<br />$operatingsystem = 'CentOS'<br />$operatingsystemrelease = '6.2'<br />$architecture = 'i686'<br />$domain = 'test.rexify.org'<br />$eth0_mac = '00:1C:42:9E:0E:28'<br />$kernel = 'Linux'<br />$swap_free = '2005'<br />$VirtInfo = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; virtualization_role =&gt; 'guest'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; virtualization_type =&gt; 'parallels'<br />&nbsp;&nbsp; }<br />$memory_shared = '0'<br />$Network = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; networkdevices =&gt; [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'eth0'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; networkconfiguration =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eth0 =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; broadcast =&gt; '10.211.55.255'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ip =&gt; '10.211.55.60'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; netmask =&gt; '255.255.255.0'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mac =&gt; '00:1C:42:9E:0E:28'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }<br />$memory_used = '440'<br />$kernelname = 'Linux'<br />$Swap = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free =&gt; '2005'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used =&gt; '10'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total =&gt; '2015'<br />&nbsp;&nbsp; }<br />$swap_total = '2015'<br />$memory_buffers = '47'<br />$eth0_ip = '10.211.55.60'<br />$swap_used = '10'<br />$memory_free = '57'<br />$manufacturer = 'Parallels Software International Inc.'<br />$Memory = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared =&gt; '0'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffers =&gt; '47'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free =&gt; '57'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used =&gt; '440'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total =&gt; '498'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cached =&gt; '357'<br />&nbsp;&nbsp; }<br />$eth0_broadcast = '10.211.55.255'<br />$eth0_netmask = '255.255.255.0'<br />$Host = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; domain =&gt; 'test.rexify.org'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; manufacturer =&gt; 'Parallels Software International Inc.'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kernelname =&gt; 'Linux'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostname =&gt; 'c6test0232'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operatingsystemrelease =&gt; '6.2'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operatingsystem =&gt; 'CentOS'<br />&nbsp;&nbsp; }</pre>
<p>You can use such predefined variable right in your template. Lets assume you want to bind apache only on your eth1 ip.</p>
<pre>Listen &lt;%= $eth1_ip %&gt;:80</pre>
<h2>Using the Module</h2>
<p>To use your module you have to add it to your Rexfile. This can be simply achieved with one line.</p>
<pre><code class="perl">use Rex -feature =&gt; ['1.3'];<br /></code><code class="perl">user "root";<br /></code><code class="perl">password "foo";<br /><br /></code><code class="perl">require Service::NTP;<br /><br /></code><code class="perl">1;</code></pre>
<p>Than you can list your Tasks and execute them.</p>
<pre>$ rex -T<br />[2013-03-30 02:35:32] INFO - eval your Rexfile.<br />Tasks<br />&nbsp; Service:NTP:prepare</pre>
<pre>$ rex -H yourserver01 Service:NTP:prepare</pre>